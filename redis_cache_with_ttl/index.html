<!DOCTYPE html> <!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--> <!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8"><![endif]--> <!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9"><![endif]--> <!--[if gt IE 8]><!--> <html class="no-js"><!--<![endif]--> <head> <meta charset="UTF-8"> <meta content="text/html; charset=UTF-8" http-equiv="Content-Type"> <meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"> <title>Spring framework Cache &#8211; lahuman</title> <meta name="description" content="열심히 사는 아저씨"> <meta name="keywords" content="spring, cache, redis"> <!-- Twitter Cards --> <meta name="twitter:card" content="summary"> <meta name="twitter:image" content="https://lahuman.github.io/assets/img/logo.png"> <meta name="twitter:title" content="Spring framework Cache"> <meta name="twitter:description" content="Spring data Reids Cache 를 쓰다, ttl 설정이 불편해서 수정 해보았습니다."> <!-- Open Graph --> <meta property="og:locale" content="ko_KR"> <meta property="og:type" content="article"> <meta property="og:title" content="Spring framework Cache"> <meta property="og:description" content="Spring data Reids Cache 를 쓰다, ttl 설정이 불편해서 수정 해보았습니다."> <meta property="og:url" content="https://lahuman.github.io/redis_cache_with_ttl/"> <meta property="og:site_name" content="lahuman"> <meta property="og:image" content="https://lahuman.github.io/assets/img/logo.png"> <link rel="canonical" href="https://lahuman.github.io/redis_cache_with_ttl/"> <link href="https://lahuman.github.io/feed.xml" type="application/atom+xml" rel="alternate" title="lahuman Feed"> <!-- Handheld --> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- CSS --> <link rel="stylesheet" href="https://lahuman.github.io/assets/css/main.css"> <!-- JS --> <script src="https://lahuman.github.io/assets/js/modernizr-3.3.1.custom.min.js"></script> <!-- Favicons --> <link rel="apple-touch-icon" href="https://lahuman.github.io/assets/img/favicons/apple-icon-precomposed.png"> <link rel="apple-touch-icon" sizes="72x72" href="https://lahuman.github.io/assets/img/favicons/apple-icon-72x72.png"> <link rel="apple-touch-icon" sizes="114x114" href="https://lahuman.github.io/assets/img/favicons/apple-icon-114x114.png"> <link rel="apple-touch-icon" sizes="144x144" href="https://lahuman.github.io/assets/img/favicons/apple-icon-144x144.png"> <link rel="shortcut icon" type="image/png" href="https://lahuman.github.io/favicon.png" /> <link rel="shortcut icon" href="https://lahuman.github.io/favicon.ico" /> <!-- mermaid --> <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script> <script>mermaid.initialize({startOnLoad:true});</script> <!-- Background Image --> <style type="text/css">body {background-image:url(https://lahuman.github.io/assets/img/placeholder-big.jpg); background-repeat: no-repeat; background-size: cover; }</style> <!-- Post Feature Image --> </head> <body> <nav id="dl-menu" class="dl-menuwrapper" role="navigation"> <button class="dl-trigger">Open Menu</button> <ul class="dl-menu"> <li><a href="https://lahuman.github.io/">Home</a></li> <li> <a href="#">About</a> <ul class="dl-submenu"> <li> <img src="https://lahuman.github.io/assets/img/logo.png" alt="lahuman photo" class="author-photo"> <h4>lahuman</h4> <p>열심히 사는 아저씨</p> </li> <li><a href="https://lahuman.github.io/about/"><span class="btn btn-inverse">Learn More</span></a></li> <li> <a href="http://facebook.com/lahuman" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-facebook-square"></i> Facebook</a> </li> <li> <a href="http://linkedin.com/in/lahuman" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-linkedin-square"></i> LinkedIn</a> </li> <li> <a href="http://github.com/lahuman" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-github"></i> Github</a> </li> </ul>
<!-- /.dl-submenu --> </li> <li> <a href="#">Posts</a> <ul class="dl-submenu"> <li><a href="https://lahuman.github.io/posts/">All Posts</a></li> <li><a href="https://lahuman.github.io/tags/">All Tags</a></li> </ul> </li> <li><a href="https://lahuman.github.io/projects/">Projects</a></li> </ul>
<!-- /.dl-menu --> </nav><!-- /.dl-menuwrapper --> <!-- Header --> <header class="header" role="banner"> <div class="wrapper animated fadeIn"> <div class="content"> <div class="post-title "> <h1>Spring framework Cache</h1> <h4>29 Aug 2024</h4> <p class="reading-time"> <i class="fa fa-clock-o"></i> Reading time ~4 minutes </p>
<!-- /.entry-reading-time --> <a class="btn zoombtn" href="https://lahuman.github.io/posts/"> <i class="fa fa-chevron-left"></i> </a> </div> <h1 id="redis와-spring-aop를-이용한-캐시-관리-rediscacheable로-ttl-설정하기">Redis와 Spring AOP를 이용한 캐시 관리: RedisCacheable로 TTL 설정하기</h1> <p>애플리케이션 성능을 최적화하기 위해서는 캐시를 활용하는 것이 매우 중요합니다. 특히, Redis는 고속의 인메모리 데이터 저장소로써 Spring과 결합해 캐시를 관리하는 데 아주 유용합니다. 이번 포스팅에서는 <a href="https://github.com/RedisCacheable" class="user-mention">@RedisCacheable</a>이라는 커스텀 어노테이션을 사용하여 TTL(Time to Live)로 Redis 캐시의 생명주기를 관리하는 방법을 소개하려 합니다.</p> <h2 id="1-rediscacheable-어노테이션-정의">1. <a href="https://github.com/RedisCacheable" class="user-mention">@RedisCacheable</a> 어노테이션 정의</h2> <p>우선 <a href="https://github.com/RedisCacheable" class="user-mention">@RedisCacheable</a> 어노테이션을 정의합니다. 이 어노테이션은 메서드에 적용되어, 메서드의 반환값을 Redis에 캐싱하도록 해줍니다. 이를 통해 반복되는 데이터 조회 작업의 부담을 줄일 수 있습니다.</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Target</span><span class="o">(</span><span class="n">AnnotationTarget</span><span class="o">.</span><span class="na">FUNCTION</span><span class="o">)</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="n">AnnotationRetention</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="n">annotation</span> <span class="kd">class</span> <span class="nf">RedisCacheable</span><span class="o">(</span>
    <span class="n">val</span> <span class="nl">name:</span> <span class="n">String</span><span class="o">,</span>
    <span class="n">val</span> <span class="nl">key:</span> <span class="n">String</span> <span class="o">=</span> <span class="s">""</span><span class="o">,</span>
    <span class="n">val</span> <span class="nl">ttl:</span> <span class="n">Long</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">,</span>
    <span class="n">val</span> <span class="nl">hasClassAndMethodNamePrefix:</span> <span class="n">Boolean</span> <span class="o">=</span> <span class="kc">false</span>
<span class="o">)</span>

<span class="nd">@Target</span><span class="o">(</span><span class="n">AnnotationTarget</span><span class="o">.</span><span class="na">FUNCTION</span><span class="o">)</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="n">AnnotationRetention</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="n">annotation</span> <span class="kd">class</span> <span class="nf">RedisCacheEvict</span><span class="o">(</span>
    <span class="n">val</span> <span class="nl">name:</span> <span class="n">Array</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;,</span>
    <span class="n">val</span> <span class="nl">key:</span> <span class="n">String</span> <span class="o">=</span> <span class="s">""</span><span class="o">,</span>
    <span class="n">val</span> <span class="nl">clearAll:</span> <span class="n">Boolean</span> <span class="o">=</span> <span class="kc">false</span><span class="o">,</span>
    <span class="n">val</span> <span class="nl">hasClassAndMethodNamePrefix:</span> <span class="n">Boolean</span> <span class="o">=</span> <span class="kc">false</span>
<span class="o">)</span>

<span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">samsungfire</span><span class="o">.</span><span class="na">chacpet</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">annotation</span>

<span class="nd">@Target</span><span class="o">(</span><span class="n">AnnotationTarget</span><span class="o">.</span><span class="na">FUNCTION</span><span class="o">)</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="n">AnnotationRetention</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="n">annotation</span> <span class="kd">class</span> <span class="nf">RedisCacheEvict</span><span class="o">(</span>
    <span class="n">val</span> <span class="nl">name:</span> <span class="n">Array</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;,</span>
    <span class="n">val</span> <span class="nl">key:</span> <span class="n">String</span> <span class="o">=</span> <span class="s">""</span><span class="o">,</span>
    <span class="n">val</span> <span class="nl">clearAll:</span> <span class="n">Boolean</span> <span class="o">=</span> <span class="kc">false</span><span class="o">,</span>
    <span class="n">val</span> <span class="nl">hasClassAndMethodNamePrefix:</span> <span class="n">Boolean</span> <span class="o">=</span> <span class="kc">false</span>
<span class="o">)</span>

</code></pre></div></div> <ul> <li>name: Redis에서 사용할 캐시 이름을 지정합니다.</li> <li>key: 캐시에 사용할 특정 키를 지정합니다. 메서드의 파라미터 값들을 기반으로 키가 생성됩니다.</li> <li>ttl: 캐시의 유효 기간을 초 단위로 설정합니다. 기본값은 -1로, 이 경우 캐시가 만료되지 않습니다.</li> <li>hasClassAndMethodNamePrefix: 캐시 키에 클래스와 메서드 이름을 포함할지 여부를 설정합니다.</li> <li>clearAll: 주어진 명명 이하로 * 를 추가해서 삭제시 사용</li> </ul> <ol> <li>RedisCacheable 어노테이션 처리하기 이제 AOP를 사용해 RedisCacheable 어노테이션을 처리하는 방법을 설명하겠습니다. RedisCacheAspect 클래스를 통해 어노테이션이 적용된 메서드를 가로채어 캐시를 관리하는 로직을 추가합니다.</li> </ol> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Aspect</span>
<span class="nd">@Component</span>
<span class="kd">class</span> <span class="nf">RedisCacheAspect</span><span class="o">(</span>
    <span class="kd">private</span> <span class="n">val</span> <span class="nl">redisTemplate:</span> <span class="n">RedisTemplate</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Any</span><span class="o">?&gt;</span>
<span class="o">)</span> <span class="o">{</span>

    <span class="nd">@Around</span><span class="o">(</span><span class="s">"@annotation(redisCacheable)"</span><span class="o">)</span>
    <span class="n">fun</span> <span class="nf">cacheableProcess</span><span class="o">(</span><span class="nl">joinPoint:</span> <span class="n">ProceedingJoinPoint</span><span class="o">,</span> <span class="nl">redisCacheable:</span> <span class="n">RedisCacheable</span><span class="o">):</span> <span class="n">Any</span><span class="o">?</span> <span class="o">{</span>
        <span class="n">val</span> <span class="n">cacheKey</span> <span class="o">=</span> <span class="n">generateKey</span><span class="o">(</span>
            <span class="n">redisCacheable</span><span class="o">.</span><span class="na">name</span><span class="o">,</span>
            <span class="n">joinPoint</span><span class="o">,</span>
            <span class="n">redisCacheable</span><span class="o">.</span><span class="na">hasClassAndMethodNamePrefix</span><span class="o">,</span>
            <span class="n">redisCacheable</span><span class="o">.</span><span class="na">key</span>
        <span class="o">)</span>
        <span class="n">val</span> <span class="n">cacheTTL</span> <span class="o">=</span> <span class="n">redisCacheable</span><span class="o">.</span><span class="na">ttl</span>

        <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">cacheKey</span><span class="o">)?.</span><span class="na">let</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">it</span>
        <span class="o">}</span>

        <span class="n">val</span> <span class="n">methodReturnValue</span> <span class="o">=</span> <span class="n">joinPoint</span><span class="o">.</span><span class="na">proceed</span><span class="o">()</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">cacheTTL</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">set</span><span class="o">(</span><span class="n">cacheKey</span><span class="o">,</span> <span class="n">methodReturnValue</span><span class="o">)</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">set</span><span class="o">(</span><span class="n">cacheKey</span><span class="o">,</span> <span class="n">methodReturnValue</span><span class="o">,</span> <span class="n">cacheTTL</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">)</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">methodReturnValue</span>
    <span class="o">}</span>


    <span class="nd">@Around</span><span class="o">(</span><span class="s">"@annotation(redisCacheEvict)"</span><span class="o">)</span>
    <span class="n">fun</span> <span class="nf">cacheEvictProcess</span><span class="o">(</span><span class="nl">joinPoint:</span> <span class="n">ProceedingJoinPoint</span><span class="o">,</span> <span class="nl">redisCacheEvict:</span> <span class="n">RedisCacheEvict</span><span class="o">):</span> <span class="n">Any</span><span class="o">?</span> <span class="o">{</span>
        <span class="n">val</span> <span class="n">methodReturnValue</span> <span class="o">=</span> <span class="n">joinPoint</span><span class="o">.</span><span class="na">proceed</span><span class="o">()</span>
        <span class="n">val</span> <span class="n">cacheKey</span> <span class="o">=</span>
                    <span class="n">generateKey</span><span class="o">(</span><span class="n">cacheName</span><span class="o">,</span> <span class="n">joinPoint</span><span class="o">,</span> <span class="n">redisCacheEvict</span><span class="o">.</span><span class="na">hasClassAndMethodNamePrefix</span><span class="o">,</span> <span class="n">redisCacheEvict</span><span class="o">.</span><span class="na">key</span><span class="o">)</span>
        <span class="n">redisCacheEvict</span><span class="o">.</span><span class="na">name</span><span class="o">.</span><span class="na">forEach</span> <span class="o">{</span> <span class="n">cacheName</span> <span class="o">-&gt;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">redisCacheEvict</span><span class="o">.</span><span class="na">clearAll</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">val</span> <span class="n">keys</span> <span class="o">=</span> <span class="n">redisTemplate</span><span class="o">.</span><span class="na">keys</span><span class="o">(</span><span class="s">"$cacheKey*"</span><span class="o">)</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">keys</span><span class="o">.</span><span class="na">isNotEmpty</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">redisTemplate</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">keys</span><span class="o">)</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">redisTemplate</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">cacheKey</span><span class="o">)</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">methodReturnValue</span>
    <span class="o">}</span>


    <span class="nd">@Around</span><span class="o">(</span><span class="s">"@annotation(redisCachePut)"</span><span class="o">)</span>
    <span class="n">fun</span> <span class="nf">cachePutProcess</span><span class="o">(</span><span class="nl">joinPoint:</span> <span class="n">ProceedingJoinPoint</span><span class="o">,</span> <span class="nl">redisCachePut:</span> <span class="n">RedisCachePut</span><span class="o">):</span> <span class="n">Any</span><span class="o">?</span> <span class="o">{</span>
        <span class="n">val</span> <span class="n">cacheKey</span> <span class="o">=</span> <span class="n">generateKey</span><span class="o">(</span>
            <span class="n">redisCachePut</span><span class="o">.</span><span class="na">name</span><span class="o">,</span>
            <span class="n">joinPoint</span><span class="o">,</span>
            <span class="n">redisCachePut</span><span class="o">.</span><span class="na">hasClassAndMethodNamePrefix</span><span class="o">,</span>
            <span class="n">redisCachePut</span><span class="o">.</span><span class="na">key</span>
        <span class="o">)</span>
        <span class="n">val</span> <span class="n">cacheTTL</span> <span class="o">=</span> <span class="n">redisCachePut</span><span class="o">.</span><span class="na">ttl</span>

        <span class="n">val</span> <span class="n">methodReturnValue</span> <span class="o">=</span> <span class="n">joinPoint</span><span class="o">.</span><span class="na">proceed</span><span class="o">()</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">cacheTTL</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">set</span><span class="o">(</span><span class="n">cacheKey</span><span class="o">,</span> <span class="n">methodReturnValue</span><span class="o">)</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">set</span><span class="o">(</span><span class="n">cacheKey</span><span class="o">,</span> <span class="n">methodReturnValue</span><span class="o">,</span> <span class="n">cacheTTL</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">)</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">methodReturnValue</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">fun</span> <span class="nf">generateKey</span><span class="o">(</span>
        <span class="nl">cacheName:</span> <span class="n">String</span><span class="o">,</span>
        <span class="nl">joinPoint:</span> <span class="n">ProceedingJoinPoint</span><span class="o">,</span>
        <span class="nl">hasClassAndMethodNamePrefix:</span> <span class="n">Boolean</span><span class="o">,</span>
        <span class="nl">key:</span> <span class="n">String</span>
    <span class="o">):</span> <span class="n">String</span> <span class="o">{</span>
        <span class="n">val</span> <span class="n">generatedKey</span> <span class="o">=</span> <span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">StringUtils</span><span class="o">.</span><span class="na">arrayToCommaDelimitedString</span><span class="o">(</span><span class="n">joinPoint</span><span class="o">.</span><span class="na">args</span><span class="o">)</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">getParameterValueByKey</span><span class="o">(</span><span class="n">joinPoint</span><span class="o">,</span> <span class="n">key</span><span class="o">)</span>
                <span class="o">?:</span> <span class="k">throw</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">"No matching parameter for key: $key"</span><span class="o">)</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="nf">if</span> <span class="o">(</span><span class="n">hasClassAndMethodNamePrefix</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">val</span> <span class="n">target</span> <span class="o">=</span> <span class="n">joinPoint</span><span class="o">.</span><span class="na">target</span><span class="o">::</span><span class="kd">class</span><span class="err">.</span><span class="nc">simpleName</span>
            <span class="n">val</span> <span class="n">method</span> <span class="o">=</span> <span class="o">(</span><span class="n">joinPoint</span><span class="o">.</span><span class="na">signature</span> <span class="n">as</span> <span class="n">MethodSignature</span><span class="o">).</span><span class="na">method</span><span class="o">.</span><span class="na">name</span>
            <span class="s">"$cacheName::$target.$method::$generatedKey"</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="s">"$cacheName::$generatedKey"</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">val</span> <span class="n">parser</span> <span class="o">=</span> <span class="n">SpelExpressionParser</span><span class="o">()</span>
    <span class="kd">private</span> <span class="n">fun</span> <span class="nf">getParameterValueByKey</span><span class="o">(</span><span class="nl">joinPoint:</span> <span class="n">ProceedingJoinPoint</span><span class="o">,</span> <span class="nl">key:</span> <span class="n">String</span><span class="o">):</span> <span class="n">String</span><span class="o">?</span> <span class="o">{</span>
        <span class="n">val</span> <span class="n">signature</span> <span class="o">=</span> <span class="n">joinPoint</span><span class="o">.</span><span class="na">signature</span> <span class="n">as</span> <span class="n">MethodSignature</span>
        <span class="n">val</span> <span class="n">parameterNames</span> <span class="o">=</span> <span class="n">signature</span><span class="o">.</span><span class="na">parameterNames</span>

        <span class="n">val</span> <span class="n">context</span> <span class="o">=</span> <span class="n">StandardEvaluationContext</span><span class="o">()</span>
        <span class="n">parameterNames</span><span class="o">.</span><span class="na">forEachIndexed</span> <span class="o">{</span> <span class="n">index</span><span class="o">,</span> <span class="n">indexedValue</span>
            <span class="o">-&gt;</span> <span class="n">context</span><span class="o">.</span><span class="na">setVariable</span><span class="o">(</span><span class="n">indexedValue</span><span class="o">,</span> <span class="n">joinPoint</span><span class="o">.</span><span class="na">args</span><span class="o">[</span><span class="n">index</span><span class="o">])</span> <span class="o">}</span>

        <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="na">parseExpression</span><span class="o">(</span><span class="n">key</span><span class="o">).</span><span class="na">getValue</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="nl">String:</span><span class="o">:</span><span class="kd">class</span><span class="err">.</span><span class="nc">java</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <h2 id="3-캐시-키-생성과-ttl-적용">3. 캐시 키 생성과 TTL 적용</h2> <p>generateKey 메서드를 이용해 캐시 키를 생성합니다. 이 키는 Redis에 저장될 데이터의 고유 식별자가 됩니다. TTL 값은 캐시의 생명주기를 관리하는 데 사용되며, 지정된 TTL이 지나면 캐시는 자동으로 만료됩니다. TTL 값이 지정되지 않았다면 캐시는 영구적으로 유지됩니다.</p> <h2 id="4-실제-사용-예시">4. 실제 사용 예시</h2> <p>이제 <a href="https://github.com/RedisCacheable" class="user-mention">@RedisCacheable</a> 어노테이션을 실제 코드에 적용해 보겠습니다:</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RedisCacheable</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"petCache"</span><span class="o">,</span> <span class="n">key</span> <span class="o">=</span> <span class="s">"#petType"</span><span class="o">,</span> <span class="n">ttl</span> <span class="o">=</span> <span class="mi">3600</span><span class="o">)</span>
<span class="n">fun</span> <span class="nf">getPetDetails</span><span class="o">(</span><span class="nl">petType:</span> <span class="n">String</span><span class="o">):</span> <span class="n">PetDetails</span> <span class="o">{</span>
    <span class="c1">// 데이터베이스 또는 외부 API를 통해 데이터를 조회하는 로직</span>
    <span class="k">return</span> <span class="n">petService</span><span class="o">.</span><span class="na">getPetDetails</span><span class="o">(</span><span class="n">petType</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div> <p>위 메서드는 petType을 키로 하여 petCache에 캐싱됩니다. 캐시는 3600초(1시간) 동안 유효하며, 이후에는 자동으로 만료됩니다.</p> <h2 id="5-적재된-cache가-redis-에서-조회가-안될-경우-처리-방법">5. 적재된 cache가 redis 에서 조회가 안될 경우 처리 방법</h2> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">@Bean</span>
    <span class="n">fun</span> <span class="nf">redisTemplate</span><span class="o">(</span><span class="nl">connectionFactory:</span> <span class="n">RedisConnectionFactory</span><span class="o">):</span> <span class="n">RedisTemplate</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Any</span><span class="o">&gt;?</span> <span class="o">{</span>
        <span class="n">val</span> <span class="n">template</span> <span class="o">=</span> <span class="n">RedisTemplate</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Any</span><span class="o">&gt;().</span><span class="na">apply</span> <span class="o">{</span>
            <span class="n">setConnectionFactory</span><span class="o">(</span><span class="n">connectionFactory</span><span class="o">)</span>
            <span class="n">setKeySerializer</span><span class="o">(</span><span class="n">StringRedisSerializer</span><span class="o">())</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">template</span>
    <span class="o">}</span>
</code></pre></div></div> <p><code class="highlighter-rouge">setKeySerializer(StringRedisSerializer())</code> 라인은 RedisTemplate이 Redis에 데이터를 저장하거나 조회할 때 사용하는 키의 직렬화 방식을 설정하는 부분입니다.</p> <p>RedisTemplate은 Redis와의 상호작용을 추상화하여 간단한 API를 제공합니다. 이 때 Redis에 저장되는 데이터의 키와 값은 각각 직렬화가 필요합니다. KeySerializer는 Redis에 저장되는 키를 어떻게 직렬화할지를 결정합니다.</p> <p>기본적으로 RedisTemplate의 키 직렬화는 <code class="highlighter-rouge">JdkSerializationRedisSerializer</code>을 사용합니다. 이 방식은 Java의 기본 직렬화 방식을 사용하여 객체를 바이트 배열로 변환합니다. 하지만, 일반적으로 Redis 키는 문자열로 저장되는 것이 좋습니다. 그 이유는</p> <ul> <li>문자열은 Redis CLI나 기타 관리 도구로 쉽게 조회할 수 있습니다.</li> <li>다른 언어나 시스템과의 호환성이 높습니다.</li> </ul> <h2 id="마치며">마치며</h2> <p>이번 포스팅에서는 <a href="https://github.com/RedisCacheable" class="user-mention">@RedisCacheable</a> 어노테이션과 AOP를 활용해 Redis 캐싱을 어떻게 구현하고 TTL로 캐시의 생명주기를 관리하는지를 살펴보았습니다. 이를 통해 데이터 조회 성능을 크게 향상시킬 수 있으며, 특히 빈번한 데이터 변경이 없는 경우 유용하게 사용할 수 있습니다. Redis와 Spring의 조합을 통해 성능 최적화에 한 발 더 나아가 보세요!</p> <h2 id="참고자료">참고자료</h2> <ul> <li><a href="https://docs.spring.io/spring-data/redis/reference/redis/redis-cache.html">Redis Cache</a></li> <li><a href="https://github.com/spring-projects/spring-framework/blob/main/spring-context/src/main/java/org/springframework/cache/interceptor/SimpleKey.java">spring-framework/spring-context/src/main/java/org/springframework/cache/interceptor/SimpleKey.java</a></li> <li><a href="https://jgrammer.tistory.com/entry/Spring-Boot-%EB%A7%8C%EB%A3%8C%EC%8B%9C%EA%B0%84-%EC%84%A4%EC%A0%95%EC%9D%84-%EC%9C%84%ED%95%9C-Redis-Cache-AOP-%EC%9E%91%EC%84%B1">Spring Boot 캐시 만료시간 설정을 위한 Redis Cache AOP 작성</a></li> </ul> <div class="entry-meta"> <br> <hr> <span class="entry-tags"><a href="https://lahuman.github.io/tags/#spring" title="Pages tagged spring" class="tag"><span class="term">spring</span></a><a href="https://lahuman.github.io/tags/#cache" title="Pages tagged cache" class="tag"><span class="term">cache</span></a><a href="https://lahuman.github.io/tags/#redis" title="Pages tagged redis" class="tag"><span class="term">redis</span></a></span> <span class="social-share"> <a href="https://www.facebook.com/sharer/sharer.php?u=https://lahuman.github.io/redis_cache_with_ttl/" title="Share on Facebook" class="tag"> <span class="term"><i class="fa fa-facebook-square"></i> Share</span> </a> <a href="https://twitter.com/intent/tweet?text=https://lahuman.github.io/redis_cache_with_ttl/" title="Share on Twitter" class="tag"> <span class="term"><i class="fa fa-twitter-square"></i> Tweet</span> </a> <a href="https://plus.google.com/share?url=https://lahuman.github.io/redis_cache_with_ttl/" title="Share on Google+" class="tag"> <span class="term"><i class="fa fa-google-plus-square"></i> +1</span> </a> </span> <div style="clear:both"></div> </div> <ins class="kakao_ad_area" style="display:none;" data-ad-unit="DAN-ubp67fs9s850" data-ad-width="320" data-ad-height="100"></ins> <script type="text/javascript" src="//t1.daumcdn.net/kas/static/ba.min.js" async></script> </div> </div> <section id="disqus_thread" class="animated fadeInUp"></section><!-- /#disqus_thread --> </header> <!-- JS --> <script src="https://lahuman.github.io/assets/js/jquery-1.12.0.min.js"></script> <script src="https://lahuman.github.io/assets/js/jquery.dlmenu.min.js"></script> <script src="https://lahuman.github.io/assets/js/jquery.goup.min.js"></script> <script src="https://lahuman.github.io/assets/js/jquery.magnific-popup.min.js"></script> <script src="https://lahuman.github.io/assets/js/jquery.fitvid.min.js"></script> <script src="https://lahuman.github.io/assets/js/scripts.js"></script> <!-- Global site tag (gtag.js) - Google Analytics --> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-74095083-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-74095083-1'); </script> <script type="text/javascript"> var disqus_shortname = 'daniels-blog'; (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); (function () { var s = document.createElement('script'); s.async = true; s.type = 'text/javascript'; s.src = '//' + disqus_shortname + '.disqus.com/count.js'; (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s); }()); </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript> <!-- MathJax --> <script async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> </body> </html>
