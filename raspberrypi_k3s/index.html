<!DOCTYPE html> <!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--> <!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8"><![endif]--> <!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9"><![endif]--> <!--[if gt IE 8]><!--> <html class="no-js"><!--<![endif]--> <head> <meta charset="UTF-8"> <meta content="text/html; charset=UTF-8" http-equiv="Content-Type"> <meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"> <title>라즈베리파이에 k3s 설치 하기 - 실패기 &#8211; lahuman</title> <meta name="description" content="열심히 사는 아저씨"> <meta name="keywords" content="raspberrypi, k3s"> <!-- Twitter Cards --> <meta name="twitter:card" content="summary"> <meta name="twitter:image" content="https://lahuman.github.io/assets/img/logo.png"> <meta name="twitter:title" content="라즈베리파이에 k3s 설치 하기 - 실패기"> <meta name="twitter:description" content="망한 k3s 설치 괴담입니다. 설치했으나.. 제대로 동작하지 않아요."> <!-- Open Graph --> <meta property="og:locale" content="ko_KR"> <meta property="og:type" content="article"> <meta property="og:title" content="라즈베리파이에 k3s 설치 하기 - 실패기"> <meta property="og:description" content="망한 k3s 설치 괴담입니다. 설치했으나.. 제대로 동작하지 않아요."> <meta property="og:url" content="https://lahuman.github.io/raspberrypi_k3s/"> <meta property="og:site_name" content="lahuman"> <meta property="og:image" content="https://lahuman.github.io/assets/img/logo.png"> <link rel="canonical" href="https://lahuman.github.io/raspberrypi_k3s/"> <link href="https://lahuman.github.io/feed.xml" type="application/atom+xml" rel="alternate" title="lahuman Feed"> <!-- Handheld --> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- CSS --> <link rel="stylesheet" href="https://lahuman.github.io/assets/css/main.css"> <!-- JS --> <script src="https://lahuman.github.io/assets/js/modernizr-3.3.1.custom.min.js"></script> <!-- Favicons --> <link rel="apple-touch-icon" href="https://lahuman.github.io/assets/img/favicons/apple-icon-precomposed.png"> <link rel="apple-touch-icon" sizes="72x72" href="https://lahuman.github.io/assets/img/favicons/apple-icon-72x72.png"> <link rel="apple-touch-icon" sizes="114x114" href="https://lahuman.github.io/assets/img/favicons/apple-icon-114x114.png"> <link rel="apple-touch-icon" sizes="144x144" href="https://lahuman.github.io/assets/img/favicons/apple-icon-144x144.png"> <link rel="shortcut icon" type="image/png" href="https://lahuman.github.io/favicon.png" /> <link rel="shortcut icon" href="https://lahuman.github.io/favicon.ico" /> <!-- mermaid --> <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script> <script>mermaid.initialize({startOnLoad:true});</script> <!-- Background Image --> <style type="text/css">body {background-image:url(https://lahuman.github.io/assets/img/placeholder-big.jpg); background-repeat: no-repeat; background-size: cover; }</style> <!-- Post Feature Image --> </head> <body> <nav id="dl-menu" class="dl-menuwrapper" role="navigation"> <button class="dl-trigger">Open Menu</button> <ul class="dl-menu"> <li><a href="https://lahuman.github.io/">Home</a></li> <li> <a href="#">About</a> <ul class="dl-submenu"> <li> <img src="https://lahuman.github.io/assets/img/logo.png" alt="lahuman photo" class="author-photo"> <h4>lahuman</h4> <p>열심히 사는 아저씨</p> </li> <li><a href="https://lahuman.github.io/about/"><span class="btn btn-inverse">Learn More</span></a></li> <li> <a href="http://facebook.com/lahuman" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-facebook-square"></i> Facebook</a> </li> <li> <a href="http://linkedin.com/in/lahuman" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-linkedin-square"></i> LinkedIn</a> </li> <li> <a href="http://github.com/lahuman" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-github"></i> Github</a> </li> </ul><!-- /.dl-submenu --> </li> <li> <a href="#">Posts</a> <ul class="dl-submenu"> <li><a href="https://lahuman.github.io/posts/">All Posts</a></li> <li><a href="https://lahuman.github.io/tags/">All Tags</a></li> </ul> </li> <li><a href="https://lahuman.github.io/projects/" >Projects</a></li> </ul><!-- /.dl-menu --> </nav><!-- /.dl-menuwrapper --> <!-- Header --> <header class="header" role="banner"> <div class="wrapper animated fadeIn"> <div class="content"> <div class="post-title "> <h1>라즈베리파이에 k3s 설치 하기 - 실패기</h1> <h4>13 Jan 2021</h4> <p class="reading-time"> <i class="fa fa-clock-o"></i> Reading time ~2 minutes </p><!-- /.entry-reading-time --> <a class="btn zoombtn" href="https://lahuman.github.io/posts/"> <i class="fa fa-chevron-left"></i> </a> </div> <h1 id="라즈베리파이에-k3s-설치-하기---실패기">라즈베리파이에 k3s 설치 하기 - 실패기</h1> <blockquote> <p>이 포스팅은 실패를 적은 것입니다.</p> </blockquote> <h2 id="1-라즈베리파이에-os-설치하기">1. 라즈베리파이에 OS 설치하기</h2> <p>그림과 같이 <a href="https://www.raspberrypi.org/software/operating-systems/#raspberry-pi-os-32-bit">Raspberry Pi OS 다운로드</a>페이지에서 <code class="language-plaintext highlighter-rouge">Raspberry Pi OS Lite</code> 버젼을 받습니다.</p> <blockquote> <p>다른 버젼을 사용해도 되지만, 서버용으로 GUI 없이 사용하기 위해서는 Lite 버젼이면 충분합니다.</p> </blockquote> <p><img src="/assets/img/post_img/raspberry_os_download.png" alt="" /></p> <p>그리고 SD 카드에 해당 이미지를 구워줍니다.</p> <p>그리고 부팅을 하고 몇가지 설정을 합니다.</p> <p>대부분의 설정은 부팅 후 <code class="language-plaintext highlighter-rouge">raspi-config</code> 명령어를 이용하면 쉽게 할 수 있습니다.</p> <ul> <li>인터넷 연결(WIFI)</li> <li>GPU Memory 64M =&gt; 16M</li> <li>hostname 변경(main, worker1, worker2 등)</li> <li>SSH 활성화</li> <li>iptables 사용하도록 설정(k3s는 네트워킹 기능은 내부적으로 iptables 를 사용합니다)</li> </ul> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo iptables -F
sudo update-alternatives --set iptables /usr/sbin/iptables-legacy
sudo update-alternatives --set ip6tables /usr/sbin/ip6tables-legacy
sudo reboot
</code></pre></div></div> <ul> <li>IP 고정</li> </ul> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /etc/dhcpcd.conf

# 본인 환경에 맞게 수정
interface wlan0
static ip_address=192.168.0.30
static routers=192.168.0.1
static domain_name_servers=8.8.8.8 1.1.1.1
</code></pre></div></div> <ul> <li>ulimit 설정</li> </ul> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /etc/security/limits.conf

*       -       nofile  32768
*       -       nproc   65536
</code></pre></div></div> <ul> <li>새로운 계정 생성 &amp; pi 계정 삭제</li> </ul> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># root 로 로그인
sudo -i

# lahuman 계정 생성
adduser lahuman
# lahuman 계정에 sudo 권한 부여
adduser lahuman sudo

# 재부팅 후 lahuman 계정으로 로그인하고 pi 계정을 삭제 합니다.
deluser pi
</code></pre></div></div> <p>여기까지 진행했다면, 라즈베리파이의 설정은 완료 되었습니다.</p> <h2 id="k3s-설치">k3s 설치</h2> <h3 id="mian-node-설치">mian node 설치</h3> <blockquote> <p>Standard Raspbian Buster installations do not start with cgroups enabled.</p> </blockquote> <p>Raspbian Buster(Lite 포함)은 cgroups 가 활성화 되어 있지 않아서 다음 설정을 해야 합니다.</p> <p><code class="language-plaintext highlighter-rouge">/boot/cmdline.txt</code> 에 다음을 추가 합니다.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /boot/cmdline.txt

# 기존 값이 console=serial0,115200 console=tty1 root=PARTUUID=afe9a4ef-02 rootfstype=ext4 elevator=deadline fsck.repair=yes rootwait  입니다. 
# cgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory 을 뒤에 추가 하면 됩니다.

console=serial0,115200 console=tty1 root=PARTUUID=afe9a4ef-02 rootfstype=ext4 elevator=deadline fsck.repair=yes rootwait cgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory
</code></pre></div></div> <p>이제 main node에 k3s를 스크립트를 이용해서 설치 합니다.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 홈페이지에는 sudo 옵션이 없지만, 해당 옵션이 없으면 설치가 안됩니다.
curl -sfL https://get.k3s.io | sudo sh -
</code></pre></div></div> <p>설치가 완료되었다면, node를 다음 명령어로 확인해 볼 수 있습니다</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo kubectl get nodes
</code></pre></div></div> <p><img src="/assets/img/post_img/k3s_install.png" alt="" /></p> <h3 id="worker-node-설치">worker node 설치</h3> <p>먼저, <code class="language-plaintext highlighter-rouge">main node의 k3s설치 스크립트 실행 전까지</code>와 동일한 작업을 진행합니다. 그리고 설치 main node의 토큰 값을 준비합니다.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># main 노드에서 실행
sudo cat /var/lib/rancher/k3s/server/node-token
K10098666be0809d3fe6d02354bd433fb84b67dcb747c73efacc4c2ca12cac38961::server:1f4bfcbf8cf3985a4554a706c9ad704f
</code></pre></div></div> <p>worker node에 k3s 설치를 진행합니다.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -sfL http://get.k3s.io | K3S_URL=https://192.168.0.30:6443 K3S_TOKEN=K10098666be0809d3fe6d02354bd433fb84b67dcb747c73efacc4c2ca12cac38961::server:1f4bfcbf8cf3985a4554a706c9ad704f  sudo sh -
</code></pre></div></div> <h3 id="k3s-삭제">k3s 삭제</h3> <p>삭제는 다음 명령어로 쉽게 삭제가 가능합니다.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># main node
sudo /usr/local/bin/k3s-uninstall.sh

# worker node
sudo /usr/local/bin/k3s-agent-uninstall.sh
</code></pre></div></div> <h3 id="k3s의-cpu-점유율이-장시간-동안-50-이상을-넘기고-있을-경우-처리-방안">k3s의 CPU 점유율이 장시간 동안 50% 이상을 넘기고 있을 경우 처리 방안</h3> <p>원인을 모르겠지만, 계속 켜놓을 경우 CPU의 점유율이 50%를 넘기면서 nodes 조회가 안되는 현상이 있었습니다.</p> <p>검색을 통해서 알아보니, cpu 사용에 limit을 설정 할 수 있다고 하네요.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /etc/systemd/system/k3s.service

CPUQuota=30%
CPUQuotaPeriodSec=50ms
AllowedCPUs=0
</code></pre></div></div> <p>하지만, 이렇게 설정해도 동일한 오류가 발생했습니다.</p> <p>다른 이유로는 <a href="https://blog.codybunch.com/2020/07/31/Fixing-cgroup-memory-on-Raspbian-Buster-for-Kernel-54x/">Fixing cgroup memory on Raspbian Buster for Kernel 5.4.x</a>의 내용과 같이 커널 버그라고 합니다.</p> <p>이를 해결하기 위해서는 커널을 업데이트 해야 하는데요.</p> <p>/boot/cmdline.txt 내용으 다음과 같이 수정하고,</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat /boot/cmdline.txt
console=serial0,115200 console=tty1 root=PARTUUID=dd5ac5d2-02 rootfstype=ext4 elevator=deadline fsck.repair=yes rootwait cgroup_enable=1 cgroup_memory=1 swapaccount=1 cgroup_enable=memory dwc_otg.lpm_enable=0
</code></pre></div></div> <p>다음의 명령어로 커널을 업데이트 합니다</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo PRUNE_MODULES=1 RPI_REBOOT=1 SKIP_WARNING=1 rpi-update
</code></pre></div></div> <h2 id="하지만-아무리-해봐도-동일한-현상도-나오며-worker-node를-추가-할-수-없었습니다-대부분의-이야기에서는-ubuntu를-이용하라는-내용이-많이-있네요">하지만… 아무리 해봐도 동일한 현상도 나오며, worker node를 추가 할 수 없었습니다. 대부분의 이야기에서는 ubuntu를 이용하라는 내용이 많이 있네요.</h2> <h2 id="참고자료">참고자료</h2> <ul> <li><a href="https://rancher.com/docs/k3s/latest/en/installation/installation-requirements/">Installation Requirements</a></li> <li><a href="https://opensource.com/article/20/3/kubernetes-raspberry-pi-k3s">Run Kubernetes on a Raspberry Pi with k3s</a></li> <li><a href="https://github.com/k3s-io/k3s/issues/294">k3s causes a high load average</a></li> <li><a href="https://blog.codybunch.com/2020/07/31/Fixing-cgroup-memory-on-Raspbian-Buster-for-Kernel-54x/">Fixing cgroup memory on Raspbian Buster for Kernel 5.4.x</a></li> </ul> <div class="entry-meta"> <br> <hr> <span class="entry-tags"><a href="https://lahuman.github.io/tags/#raspberrypi" title="Pages tagged raspberrypi" class="tag"><span class="term">raspberrypi</span></a><a href="https://lahuman.github.io/tags/#k3s" title="Pages tagged k3s" class="tag"><span class="term">k3s</span></a></span> <span class="social-share"> <a href="https://www.facebook.com/sharer/sharer.php?u=https://lahuman.github.io/raspberrypi_k3s/" title="Share on Facebook" class="tag"> <span class="term"><i class="fa fa-facebook-square"></i> Share</span> </a> <a href="https://twitter.com/intent/tweet?text=https://lahuman.github.io/raspberrypi_k3s/" title="Share on Twitter" class="tag"> <span class="term"><i class="fa fa-twitter-square"></i> Tweet</span> </a> <a href="https://plus.google.com/share?url=https://lahuman.github.io/raspberrypi_k3s/" title="Share on Google+" class="tag"> <span class="term"><i class="fa fa-google-plus-square"></i> +1</span> </a> </span> <div style="clear:both"></div> </div> <ins class="kakao_ad_area" style="display:none;" data-ad-unit = "DAN-ubp67fs9s850" data-ad-width = "320" data-ad-height = "100"></ins> <script type="text/javascript" src="//t1.daumcdn.net/kas/static/ba.min.js" async></script> </div> </div> <section id="disqus_thread" class="animated fadeInUp"></section><!-- /#disqus_thread --> </header> <!-- JS --> <script src="https://lahuman.github.io/assets/js/jquery-1.12.0.min.js"></script> <script src="https://lahuman.github.io/assets/js/jquery.dlmenu.min.js"></script> <script src="https://lahuman.github.io/assets/js/jquery.goup.min.js"></script> <script src="https://lahuman.github.io/assets/js/jquery.magnific-popup.min.js"></script> <script src="https://lahuman.github.io/assets/js/jquery.fitvid.min.js"></script> <script src="https://lahuman.github.io/assets/js/scripts.js"></script> <!-- Global site tag (gtag.js) - Google Analytics --> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-74095083-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-74095083-1'); </script> <script type="text/javascript"> var disqus_shortname = 'daniels-blog'; (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); (function () { var s = document.createElement('script'); s.async = true; s.type = 'text/javascript'; s.src = '//' + disqus_shortname + '.disqus.com/count.js'; (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s); }()); </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> <!-- MathJax --> <script async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> </body> </html>
