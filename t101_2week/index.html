<!DOCTYPE html> <!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--> <!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8"><![endif]--> <!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9"><![endif]--> <!--[if gt IE 8]><!--> <html class="no-js"><!--<![endif]--> <head> <meta charset="UTF-8"> <meta content="text/html; charset=UTF-8" http-equiv="Content-Type"> <meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"> <title>#2 ASG &#8211; lahuman</title> <meta name="description" content="ì—´ì‹¬íˆ ì‚¬ëŠ” ì•„ì €ì”¨"> <meta name="keywords" content="terraform, study"> <!-- Twitter Cards --> <meta name="twitter:card" content="summary"> <meta name="twitter:image" content="https://lahuman.github.io/assets/img/logo.png"> <meta name="twitter:title" content="#2 ASG"> <meta name="twitter:description" content="Terraform 101 Study"> <!-- Open Graph --> <meta property="og:locale" content="ko_KR"> <meta property="og:type" content="article"> <meta property="og:title" content="#2 ASG"> <meta property="og:description" content="Terraform 101 Study"> <meta property="og:url" content="https://lahuman.github.io/t101_2week/"> <meta property="og:site_name" content="lahuman"> <meta property="og:image" content="https://lahuman.github.io/assets/img/logo.png"> <link rel="canonical" href="https://lahuman.github.io/t101_2week/"> <link href="https://lahuman.github.io/feed.xml" type="application/atom+xml" rel="alternate" title="lahuman Feed"> <!-- Handheld --> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- CSS --> <link rel="stylesheet" href="https://lahuman.github.io/assets/css/main.css"> <!-- JS --> <script src="https://lahuman.github.io/assets/js/modernizr-3.3.1.custom.min.js"></script> <!-- Favicons --> <link rel="apple-touch-icon" href="https://lahuman.github.io/assets/img/favicons/apple-icon-precomposed.png"> <link rel="apple-touch-icon" sizes="72x72" href="https://lahuman.github.io/assets/img/favicons/apple-icon-72x72.png"> <link rel="apple-touch-icon" sizes="114x114" href="https://lahuman.github.io/assets/img/favicons/apple-icon-114x114.png"> <link rel="apple-touch-icon" sizes="144x144" href="https://lahuman.github.io/assets/img/favicons/apple-icon-144x144.png"> <link rel="shortcut icon" type="image/png" href="https://lahuman.github.io/favicon.png" /> <link rel="shortcut icon" href="https://lahuman.github.io/favicon.ico" /> <!-- mermaid --> <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script> <script>mermaid.initialize({startOnLoad:true});</script> <!-- Background Image --> <style type="text/css">body {background-image:url(https://lahuman.github.io/assets/img/placeholder-big.jpg); background-repeat: no-repeat; background-size: cover; }</style> <!-- Post Feature Image --> </head> <body> <nav id="dl-menu" class="dl-menuwrapper" role="navigation"> <button class="dl-trigger">Open Menu</button> <ul class="dl-menu"> <li><a href="https://lahuman.github.io/">Home</a></li> <li> <a href="#">About</a> <ul class="dl-submenu"> <li> <img src="https://lahuman.github.io/assets/img/logo.png" alt="lahuman photo" class="author-photo"> <h4>lahuman</h4> <p>ì—´ì‹¬íˆ ì‚¬ëŠ” ì•„ì €ì”¨</p> </li> <li><a href="https://lahuman.github.io/about/"><span class="btn btn-inverse">Learn More</span></a></li> <li> <a href="http://facebook.com/lahuman" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-facebook-square"></i> Facebook</a> </li> <li> <a href="http://linkedin.com/in/lahuman" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-linkedin-square"></i> LinkedIn</a> </li> <li> <a href="http://github.com/lahuman" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-github"></i> Github</a> </li> </ul><!-- /.dl-submenu --> </li> <li> <a href="#">Posts</a> <ul class="dl-submenu"> <li><a href="https://lahuman.github.io/posts/">All Posts</a></li> <li><a href="https://lahuman.github.io/tags/">All Tags</a></li> </ul> </li> <li><a href="https://lahuman.github.io/projects/" >Projects</a></li> </ul><!-- /.dl-menu --> </nav><!-- /.dl-menuwrapper --> <!-- Header --> <header class="header" role="banner"> <div class="wrapper animated fadeIn"> <div class="content"> <div class="post-title "> <h1>#2 ASG</h1> <h4>23 Oct 2022</h4> <p class="reading-time"> <i class="fa fa-clock-o"></i> Reading time ~8 minutes </p><!-- /.entry-reading-time --> <a class="btn zoombtn" href="https://lahuman.github.io/projects/"> <i class="fa fa-chevron-left"></i> </a> </div> <h1 id="asgauto-scaling-groups-ë°°í¬">ASG(Auto Scaling groups) ë°°í¬</h1> <blockquote> <p>ğŸ’¡ ì•„ë˜ ì„¤ì •(ì˜µì…˜ë“¤)ê³¼ ë™ì‘ ì´í•´ë¥¼ ìœ„í•´ì„œ â€˜AWS ê´€ë¦¬ ì½˜ì†”â€™ì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì§ì ‘ <strong>ELB, EC2 ASG(ì˜¤í†  ìŠ¤ì¼€ì¼ë§)</strong> ë“±ì„ ë°°í¬ í›„ì— ì•„ë˜ í…Œë¼í¼ ì‹¤ìŠµì„ ë”°ë¼ í•  ê²ƒ!</p> </blockquote> <h2 id="ëª©í‘œ--ì˜¤í† ìŠ¤ì¼€ì¼ë§-ê·¸ë£¹ìœ¼ë¡œ-ec2-ë°°í¬"><code class="language-plaintext highlighter-rouge">ëª©í‘œ</code> : ì˜¤í† ìŠ¤ì¼€ì¼ë§ ê·¸ë£¹ìœ¼ë¡œ EC2 ë°°í¬</h2> <div class="mermaid"> graph LR; A(((User))); A --&gt; B(EC2 Instance); A --&gt; C(EC2 Instance); A --&gt; D(EC2 Instance); A --&gt; E(EC2 more...); subgraph AWS; B &amp; C &amp; D &amp; E; end; </div> <h3 id="ìˆ˜ëª…-ì£¼ê¸°lifecycle-ì„¤ì •--ë¦¬ì†ŒìŠ¤ë¥¼-êµì²´í•˜ëŠ”-ìˆœì„œë¥¼-ë°˜ëŒ€ë¡œ-í•˜ì—¬-êµì²´-ë¦¬ì†ŒìŠ¤ë¥¼-ë¨¼ì €-ìƒì„±í•˜ê³ -ê¸°ì¡´-ë¦¬ì†ŒìŠ¤-ì‚­ì œ-ë™ì‘-ì„¤ì •-ê°€ëŠ¥">ìˆ˜ëª… ì£¼ê¸°(<strong>lifecycle</strong>) ì„¤ì • : ë¦¬ì†ŒìŠ¤ë¥¼ êµì²´í•˜ëŠ” ìˆœì„œë¥¼ ë°˜ëŒ€ë¡œ í•˜ì—¬ êµì²´ ë¦¬ì†ŒìŠ¤ë¥¼ ë¨¼ì € ìƒì„±í•˜ê³  ê¸°ì¡´ ë¦¬ì†ŒìŠ¤ ì‚­ì œ ë™ì‘ ì„¤ì • ê°€ëŠ¥</h3> <ul> <li>ì˜¤í† ìŠ¤ì¼€ì¼ë§ ì‹œì‘ êµ¬ì„±(launch configuration) : aws_instance ë¦¬ì†ŒìŠ¤ì™€ ê±°ì˜ ë™ì¼í•œ ë§¤ê°œ ë³€ìˆ˜ë¥¼ ì‚¬ìš©</li> <li>ì¼ë¶€ íŒŒë¼ë¯¸í„°ëŠ” ì§€ì›í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìœ¼ë©°, ëª‡ëª‡ íŒŒë¼ë¯¸í„°ëŠ” ì´ë¦„ì´ ë‹¤ë¥´ê¸°ë„ í•˜ë‹¤ <ul> <li>ami â†’ image_id</li> <li>vpc_security_group_ids â†’ security_groups</li> </ul> </li> <li>ì•„ë˜ ASG ì˜ˆì‹œ : EC2 2ëŒ€~10ëŒ€ ì‚¬ì´ ì¤‘ ì´ˆê¸° ì‹œì‘ì€ ê¸°ë³¸ê°’ 2ëŒ€ë¡œ ì‹¤í–‰ë˜ê³ , íƒœê·¸ ì§€ì •ë¨</li> </ul> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ìƒ˜í”Œ ì½”ë“œ : ì‹¤í–‰ì„ í•˜ì§€ëŠ” ì•ŠìŒ</span>
resource <span class="s2">"aws_autoscaling_group"</span> <span class="s2">"example"</span> <span class="o">{</span>
    launch_configuration <span class="o">=</span> aws_launch_configuration.example.name

    min_size <span class="o">=</span> 2
    max_size <span class="o">=</span> 10

    tag <span class="o">{</span>
    key                 <span class="o">=</span> <span class="s2">"Name"</span>
    value               <span class="o">=</span> <span class="s2">"terraform-asg-example"</span>
    propagate_at_launch <span class="o">=</span> <span class="nb">true</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <ul> <li>ASGëŠ” ì‹œì‘ êµ¬ì„± ì •ë³´ë¥¼ ì°¸ê³ í•˜ì—¬ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•˜ëŠ”ë° í•œ ê°€ì§€ ë¬¸ì œê°€ ë°œìƒ â†’ ì‹œì‘ êµ¬ì„±ì€ ë³€ê²½í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ì‹œì‘ êµ¬ì„± ë§¤ê°œ ë³€ìˆ˜ë¥¼ ë³€ê²½ ì‹œ í…Œë¼í¼ì´ ì´ë¥¼ ëŒ€ì²´í•˜ë ¤ê³  í•©ë‹ˆë‹¤.</li> <li>ì¼ë°˜ì ìœ¼ë¡œ ë¦¬ì†ŒìŠ¤ë¥¼ êµì²´í•  ë•Œ í…Œë¼í¼ì€ ì´ì „ ë¦¬ì†ŒìŠ¤ë¥¼ ë¨¼ì € ì‚­ì œí•œ ë‹¤ìŒ ëŒ€ì²´ ë¦¬ì†ŒìŠ¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ASGì— ì´ì „ ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ì°¸ì¡°ê°€ ìˆê¸° ë•Œë¬¸ì— í…Œë¼í¼ì€ í•´ë‹¹ ë¦¬ì†ŒìŠ¤ë¥¼ ì‚­ì œ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</li> <li>ì´ ë¬¸ì œ í•´ê²°ì„ ìœ„í•´ ìˆ˜ëª… ì£¼ê¸° ì„¤ì •(lifecycle)ë¥¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li> <li>ëª¨ë“  í…Œë¼í¼ ë¦¬ì†ŒìŠ¤ëŠ” ë¦¬ì†ŒìŠ¤ ìƒì„±, ì—…ë°ì´íŠ¸ ë° ì‚­ì œ ë°©ë²•ì„ êµ¬ì„±í•˜ëŠ” ëª‡ ê°€ì§€ ìˆ˜ëª… ì£¼ê¸°(<strong>lifecycle</strong>) ì„¤ì •ì„ ì§€ì›í•©ë‹ˆë‹¤.</li> <li>íŠ¹íˆ create_before_destroy ë¥¼ true ë¡œ ì„¤ì •í•˜ë©´ í…Œë¼í¼ì€ ë¦¬ì†ŒìŠ¤ë¥¼ êµì²´í•˜ëŠ” ìˆœì„œë¥¼ ë°˜ëŒ€ë¡œ í•˜ì—¬ êµì²´ ë¦¬ì†ŒìŠ¤ë¥¼ ë¨¼ì € ìƒì„±í•˜ê³ (ì´ì „ ë¦¬ì†ŒìŠ¤ê°€ ê°€ë¦¬í‚¤ê³  ìˆë˜ ì°¸ì¡°ë¥¼ ì—…ë°ì´íŠ¸í•˜ì—¬ êµì²´í•œ ë¦¬ì†ŒìŠ¤ë¥¼ ê°€ë¦¬í‚´) ê¸°ì¡´ ë¦¬ì†ŒìŠ¤ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.</li> <li>ì•„ë˜ì™€ ê°™ì¸ lifecycle ë¸”ë¡ì„ aws_launch_configuration ì— ì¶”ê°€í•©ë‹ˆë‹¤</li> </ul> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ìƒ˜í”Œ ì½”ë“œ : ì‹¤í–‰ì„ í•˜ì§€ëŠ” ì•ŠìŒ</span>
resource <span class="s2">"aws_launch_configuration"</span> <span class="s2">"example"</span> <span class="o">{</span>
    image_id        <span class="o">=</span> <span class="s2">"ami-0e9bfdb247cc8de84"</span>
    instance_type   <span class="o">=</span> <span class="s2">"t2.micro"</span>
    security_groups <span class="o">=</span> <span class="o">[</span>aws_security_group.instance.id]

    user_data <span class="o">=</span> <span class="o">&lt;&lt;-</span><span class="no">EOF</span><span class="sh">
                #!/bin/bash
                echo "Hello, World" &gt; index.html
                nohup busybox httpd -f -p </span><span class="k">${</span><span class="nv">var</span><span class="p">.server_port</span><span class="k">}</span><span class="sh"> &amp;
</span><span class="no">                EOF

</span>    <span class="c"># Required when using a launch configuration with an auto scaling group.</span>
    <span class="k">**</span>lifecycle<span class="k">**</span> <span class="o">{</span>
    <span class="k">**</span>create_before_destroy <span class="o">=</span> <span class="nb">true</span><span class="k">**</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <h3 id="asg-ë°°í¬--asgtf">ASG ë°°í¬ : <strong>asg.tf</strong></h3> <blockquote> <p><a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/autoscaling_group">Terraform Registry</a></p> </blockquote> <ul> <li>ì½”ë“œ íŒŒì¼ ì‘ì„± : CMDì°½ì—ì„œ ë°”ë¡œ ë³µì‚¬&amp;ë¶™ì—¬ë„£ê¸°ë¡œ main.tf íŒŒì¼ ìƒì„± ì‹œ <strong>** ì£¼ì˜ â‡’ ê·¸ëƒ¥ ì§ì ‘ **IDE</strong>ì— ë¶™ì—¬ë„£ì„ë•ŒëŠ” **** ì œê±°í•˜ì„¸ìš”</li> </ul> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOT</span><span class="sh"> &gt; asg.tf
data "aws_ami" "my_amazonlinux2" {
  most_recent = true
  filter {
    name   = "owner-alias"
    values = ["amazon"]
  }

  filter {
    name   = "name"
    values = ["amzn2-ami-hvm-*-x86_64-ebs"]
  }

  owners = ["amazon"]
}

resource "aws_launch_configuration" "mylauchconfig" {
  name_prefix     = "t101-lauchconfig-"
  image_id        = data.aws_ami.my_amazonlinux2.id
  instance_type   = "t2.micro"
  security_groups = [aws_security_group.mysg.id]
  associate_public_ip_address = true

  user_data = &lt;&lt;-EOF
              #!/bin/bash
              wget https://busybox.net/downloads/binaries/1.31.0-defconfig-multiarch-musl/busybox-x86_64
              mv busybox-x86_64 busybox
              chmod +x busybox
              RZAZ=</span><span class="se">\$</span><span class="sh">(curl http://169.254.169.254/latest/meta-data/placement/availability-zone-id)
              IID=</span><span class="se">\$</span><span class="sh">(curl 169.254.169.254/latest/meta-data/instance-id)
              LIP=</span><span class="se">\$</span><span class="sh">(curl 169.254.169.254/latest/meta-data/local-ipv4)
              echo "&lt;h1&gt;RegionAz(</span><span class="se">\$</span><span class="sh">RZAZ) : Instance ID(</span><span class="se">\$</span><span class="sh">IID) : Private IP(</span><span class="se">\$</span><span class="sh">LIP) : Web Server&lt;/h1&gt;" &gt; index.html
              nohup ./busybox httpd -f -p 80 &amp;
              EOF

  # Required when using a launch configuration with an auto scaling group.
  lifecycle {
    create_before_destroy = true
  }
}

resource "aws_autoscaling_group" "myasg" {
  name                 = "myasg"
  launch_configuration = aws_launch_configuration.mylauchconfig.name
  vpc_zone_identifier  = [aws_subnet.mysubnet1.id, aws_subnet.mysubnet2.id]
  min_size = 2
  max_size = 10

  tag {
    key                 = "Name"
    value               = "terraform-asg"
    propagate_at_launch = true
  }
}
</span><span class="no">EOT
</span></code></pre></div></div> <h3 id="ë°°í¬">ë°°í¬</h3> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># [í„°ë¯¸ë„1] EC2 ìƒì„± ëª¨ë‹ˆí„°ë§</span>
<span class="c"># macOS</span>
<span class="nb">export </span><span class="nv">AWS_PAGER</span><span class="o">=</span><span class="s2">""</span>
<span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>aws ec2 describe-instances <span class="nt">--query</span> <span class="s2">"Reservations[*].Instances[*].{PublicIPAdd:PublicIpAddress,InstanceName:Tags[?Key=='Name']|[0].Value,Status:State.Name}"</span> <span class="nt">--filters</span> <span class="nv">Name</span><span class="o">=</span>instance-state-name,Values<span class="o">=</span>running <span class="nt">--output</span> text <span class="p">;</span> <span class="nb">echo</span> <span class="s2">"------------------------------"</span> <span class="p">;</span> <span class="nb">sleep </span>1<span class="p">;</span> <span class="k">done</span>

<span class="c"># ë°°í¬</span>
terraform plan <span class="o">&amp;&amp;</span> terraform apply <span class="nt">-auto-approve</span>
terraform state list
aws_autoscaling_group.myasg
aws_launch_configuration.mylauchconfig
...

<span class="c"># curl ì ‘ì† í™•ì¸</span>
<span class="nv">IP1</span><span class="o">=</span>&lt;EC2 1ë²ˆ Public IP&gt;
<span class="nv">IP2</span><span class="o">=</span>&lt;EC2 2ë²ˆ Public IP&gt;
<span class="nb">echo</span> <span class="s2">"</span><span class="nv">$IP1</span><span class="s2"> - WebSrv"</span> <span class="p">;</span> curl <span class="nt">-s</span> <span class="nv">$IP1</span> <span class="p">;</span> <span class="nb">echo</span> <span class="p">;</span> <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$IP2</span><span class="s2"> - WebSrv"</span> <span class="p">;</span> curl <span class="nt">-s</span> <span class="nv">$IP2</span> <span class="p">;</span> <span class="nb">echo</span>
</code></pre></div></div> <h3 id="aws-ê´€ë¦¬-ì½˜ì†”--asg-ì‹œì‘-êµ¬ì„±-as-ê·¸ë£¹-í™•ì¸">AWS ê´€ë¦¬ ì½˜ì†” : ASG ì‹œì‘ êµ¬ì„±, AS ê·¸ë£¹ í™•ì¸</h3> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ASG ì‹œì‘ êµ¬ì„±, AS ê·¸ë£¹ ì •ë³´ í™•ì¸</span>
aws autoscaling describe-auto-scaling-groups <span class="nt">--auto-scaling-group-names</span> | jq
aws autoscaling describe-auto-scaling-groups <span class="nt">--auto-scaling-group-names</span> <span class="nt">--output</span> table
aws autoscaling describe-auto-scaling-groups <span class="nt">--auto-scaling-group-names</span> myasg| jq
aws autoscaling describe-scaling-activities <span class="nt">--auto-scaling-group-name</span> myasg | jq
</code></pre></div></div> <h2 id="ë¡œë“œ-ë°¸ëŸ°ì„œ-ë°°í¬">ë¡œë“œ ë°¸ëŸ°ì„œ ë°°í¬</h2> <h3 id="ëª©í‘œ--asg-ì—-alb-ì—°ë™-ë°°í¬"><code class="language-plaintext highlighter-rouge">ëª©í‘œ</code> : ASG ì— ALB ì—°ë™ ë°°í¬</h3> <div class="mermaid"> graph LR; A(((User))); A --&gt; F; subgraph AWS; F; F --&gt; B(EC2 Instance); F --&gt; C(EC2 Instance); F --&gt; D(EC2 Instance); F --&gt; E(EC2 more...); end; </div> <p><strong>ALB êµ¬ì„±</strong> : Listener, Listener rule, Target groups</p> <div class="mermaid"> graph LR A(((Request))) A --&gt; F; subgraph ALB subgraph Listeners F(Port 80, HTTP) G(Port 443, HTTPS) end subgraph Listeners Rules F --&gt; B(foo.example.com) F --&gt; C(bar.example.com) G --&gt; D(/foo/*) G --&gt; E(/bar/*) end subgraph Target Group1 H(foo) I(foo) end B &amp; D ---&gt; H &amp; I; subgraph Target Group2 J(bar) K(bar) end C &amp; E ---&gt; J &amp; K; end </div> <h3 id="ë°°í¬--albtf">ë°°í¬ : <strong>alb.tf</strong></h3> <blockquote> <p><a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lb">Terraform Registry</a></p> <ul> <li>ALB ìƒì„± ```bash cat Â«EOT &gt; alb.tf resource â€œaws_lbâ€ â€œmyalbâ€ { name = â€œt101-albâ€ load_balancer_type = â€œapplicationâ€ subnets = [aws_subnet.mysubnet1.id, aws_subnet.mysubnet2.id] security_groups = [aws_security_group.mysg.id]</li> </ul> </blockquote> <p>tags = { Name = â€œt101-albâ€ } }</p> <p>output â€œmyalb_dnsâ€ { value = aws_lb.myalb.dns_name description = â€œThe DNS Address of the ALBâ€ }</p> <p>EOT</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>```bash
# ë°°í¬ : 2ë¶„ 10ì´ˆ ì •ë„ ì†Œìš”
terraform plan &amp;&amp; terraform apply -auto-approve
Outputs:
myalb_dns = "t101-alb-1753585046.ap-northeast-2.elb.amazonaws.com"

terraform state list
aws_lb.myalb
...

# ALB ì •ë³´ í™•ì¸
aws elbv2 describe-load-balancers --output table
aws elbv2 describe-load-balancers | jq

# [í„°ë¯¸ë„2] ì¶œë ¥ëœ ALB DNSì£¼ì†Œë¡œ cul ì ‘ì† í™•ì¸
cd my-vpc-ec2-asg
terraform output -raw myalb_dns
t101-alb-1753585046.ap-northeast-2.elb.amazonaws.com

ALBDNS=$(terraform output -raw myalb_dns)
while true; do curl --connect-timeout 1  http://$ALBDNS/ ; echo; echo "------------------------------"; date; sleep 1; done
</code></pre></div></div> <ul> <li>ALBì˜ ë¦¬ìŠ¤ë„ˆ ìƒì„± : http 80 ì¸ì…, ë¦¬ìŠ¤ë„ˆ ê·œì¹™ê³¼ ì¼ì¹˜í•˜ì§€ ì•Šì„ ê²½ìš° 404 í˜ì´ì§€ ë¦¬í„´</li> </ul> <blockquote> <p><a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lb_listener">Terraform Registry</a></p> </blockquote> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOT</span><span class="sh"> &gt; alb.tf
resource "aws_lb" "myalb" {
  name               = "t101-alb"
  load_balancer_type = "application"
  subnets            = [aws_subnet.mysubnet1.id, aws_subnet.mysubnet2.id]
  security_groups = [aws_security_group.mysg.id]

  tags = {
    Name = "t101-alb"
  }
}

resource "aws_lb_listener" "myhttp" {
  load_balancer_arn = aws_lb.myalb.arn
  port              = 80
  protocol          = "HTTP"

  # By default, return a simple 404 page
  default_action {
    type = "fixed-response"

    fixed_response {
      content_type = "text/plain"
      message_body = "404: page not found - T101 Study"
      status_code  = 404
    }
  }
}

output "myalb_dns" {
  value       = aws_lb.myalb.dns_name
  description = "The DNS Address of the ALB"
}
</span><span class="no">EOT
</span></code></pre></div></div> <ul> <li>ë°°í¬ í›„ ì ‘ì†</li> </ul> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë°°í¬</span>
terraform plan <span class="o">&amp;&amp;</span> terraform apply <span class="nt">-auto-approve</span>

<span class="c"># ALB DNS ì£¼ì†Œ curl ì ‘ì† í™•ì¸</span>
</code></pre></div></div> <ul> <li>ë‹¤ìŒìœ¼ë¡œ aws_lb_target_group ë¦¬ì†ŒìŠ¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ASGì˜ ëŒ€ìƒ ê·¸ë£¹ì„ ìƒì„±</li> </ul> <blockquote> <p><a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lb_target_group">Terraform Registry</a></p> </blockquote> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOT</span><span class="sh"> &gt; alb.tf
resource "aws_lb" "myalb" {
  name               = "t101-alb"
  load_balancer_type = "application"
  subnets            = [aws_subnet.mysubnet1.id, aws_subnet.mysubnet2.id]
  security_groups = [aws_security_group.mysg.id]

  tags = {
    Name = "t101-alb"
  }
}

resource "aws_lb_listener" "myhttp" {
  load_balancer_arn = aws_lb.myalb.arn
  port              = 80
  protocol          = "HTTP"

  # By default, return a simple 404 page
  default_action {
    type = "fixed-response"

    fixed_response {
      content_type = "text/plain"
      message_body = "404: page not found - T101 Study"
      status_code  = 404
    }
  }
}

resource "aws_lb_target_group" "myalbtg" {
  name = "t101-alb-tg"
  port     = 80
  protocol = "HTTP"
  vpc_id   = aws_vpc.myvpc.id

  health_check {
    path                = "/"
    protocol            = "HTTP"
    matcher             = "200-299"
    interval            = 5
    timeout             = 3
    healthy_threshold   = 2
    unhealthy_threshold = 2
  }
}

output "myalb_dns" {
  value       = aws_lb.myalb.dns_name
  description = "The DNS Address of the ALB"
}
</span><span class="no">EOT
</span></code></pre></div></div> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë°°í¬</span>
terraform plan <span class="o">&amp;&amp;</span> terraform apply <span class="nt">-auto-approve</span>

<span class="c"># ALB ëŒ€ìƒ ê·¸ë£¹ í™•ì¸ : ì•„ì§ì€ íƒ€ì¼“ ëŒ€ìƒ(EC2) ì—†ìŒ</span>
</code></pre></div></div> <h3 id="alb--asg-ì—°ë™--asgtf">ALB + ASG ì—°ë™ : <strong>asg.tf</strong></h3> <ul> <li>ëŒ€ìƒê·¸ë£¹ì€ ì–´ëŠ EC2ì— ìš”ì²­ì„ ë³´ë‚´ëŠ”ì§€ ì•„ë‚˜ìš”? â†’ ASG + ALB í†µí•© ì´ì  í™œìš©(aws_autoscaling_group ë¦¬ì†ŒìŠ¤ì— target_group_arns ì¸ìˆ˜ë¥¼ ì„¤ì •)í•˜ì—¬ ìƒˆ ëŒ€ìƒ ê·¸ë£¹ì„ ì§€ì •</li> <li>ì´ë•Œ í—¬ìŠ¤ì²´í¬ë„ EC2ê°€ ì•„ë‹Œ ELBë¡œ ë³€ê²½ â†’ ì´ ê²½ìš° EC2 ë¶ˆëŸ‰ ì‹œ ìë™ìœ¼ë¡œ ì¸ìŠ¤í„´ìŠ¤ê°€ êµì²´ë˜ê³  ëŒ€ìƒê·¸ë£¹ì— ë“±ë¡ë¨</li> <li>ì½”ë“œ íŒŒì¼ ì‘ì„± : CMDì°½ì—ì„œ ë°”ë¡œ ë³µì‚¬&amp;ë¶™ì—¬ë„£ê¸°ë¡œ main.tf íŒŒì¼ ìƒì„± ì‹œ <strong>** ì£¼ì˜ â‡’ ê·¸ëƒ¥ ì§ì ‘ **IDE</strong>ì— ë¶™ì—¬ë„£ì„ë•ŒëŠ” **** ì œê±°í•˜ì„¸ìš”</li> </ul> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOT</span><span class="sh"> &gt; asg.tf
data "aws_ami" "my_amazonlinux2" {
  most_recent = true
  filter {
    name   = "owner-alias"
    values = ["amazon"]
  }

  filter {
    name   = "name"
    values = ["amzn2-ami-hvm-*-x86_64-ebs"]
  }

  owners = ["amazon"]
}

resource "aws_launch_configuration" "mylauchconfig" {
  name_prefix     = "t101-lauchconfig-"
  image_id        = data.aws_ami.my_amazonlinux2.id
  instance_type   = "t2.micro"
  security_groups = [aws_security_group.mysg.id]
  associate_public_ip_address = true

  user_data = &lt;&lt;-EOF
              #!/bin/bash
              wget https://busybox.net/downloads/binaries/1.31.0-defconfig-multiarch-musl/busybox-x86_64
              mv busybox-x86_64 busybox
              chmod +x busybox
              RZAZ=</span><span class="se">\$</span><span class="sh">(curl http://169.254.169.254/latest/meta-data/placement/availability-zone-id)
              IID=</span><span class="se">\$</span><span class="sh">(curl 169.254.169.254/latest/meta-data/instance-id)
              LIP=</span><span class="se">\$</span><span class="sh">(curl 169.254.169.254/latest/meta-data/local-ipv4)
              echo "&lt;h1&gt;RegionAz(</span><span class="se">\$</span><span class="sh">RZAZ) : Instance ID(</span><span class="se">\$</span><span class="sh">IID) : Private IP(</span><span class="se">\$</span><span class="sh">LIP) : Web Server&lt;/h1&gt;" &gt; index.html
              nohup ./busybox httpd -f -p 80 &amp;
              EOF

  # Required when using a launch configuration with an auto scaling group.
  lifecycle {
    create_before_destroy = true
  }
}

resource "aws_autoscaling_group" "myasg" {
  name                 = "myasg"
  launch_configuration = aws_launch_configuration.mylauchconfig.name
  vpc_zone_identifier  = [aws_subnet.mysubnet1.id, aws_subnet.mysubnet2.id]
  min_size = 2
  max_size = 10
  health_check_type = "ELB"
  target_group_arns = [aws_lb_target_group.myalbtg.arn]

  tag {
    key                 = "Name"
    value               = "terraform-asg"
    propagate_at_launch = true
  }
}
</span><span class="no">EOT
</span></code></pre></div></div> <blockquote> <p><a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lb_listener_rule">Terraform Registry</a></p> </blockquote> <ul> <li>ë§ˆì§€ë§‰ìœ¼ë¡œ aws_lb_listener_rule ë¦¬ì†ŒìŠ¤ë¥¼ ì‚¬ìš©í•´ ë¦¬ìŠ¤ë„ˆ ê·œì¹™ì„ ìƒì„±í•˜ì—¬ ì—°ê²°</li> </ul> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOT</span><span class="sh"> &gt; alb.tf
resource "aws_lb" "myalb" {
  name               = "t101-alb"
  load_balancer_type = "application"
  subnets            = [aws_subnet.mysubnet1.id, aws_subnet.mysubnet2.id]
  security_groups = [aws_security_group.mysg.id]

  tags = {
    Name = "t101-alb"
  }
}

resource "aws_lb_listener" "myhttp" {
  load_balancer_arn = aws_lb.myalb.arn
  port              = 80
  protocol          = "HTTP"

  # By default, return a simple 404 page
  default_action {
    type = "fixed-response"

    fixed_response {
      content_type = "text/plain"
      message_body = "404: page not found - T101 Study"
      status_code  = 404
    }
  }
}

resource "aws_lb_target_group" "myalbtg" {
  name = "t101-alb-tg"
  port     = 80
  protocol = "HTTP"
  vpc_id   = aws_vpc.myvpc.id

  health_check {
    path                = "/"
    protocol            = "HTTP"
    matcher             = "200-299"
    interval            = 5
    timeout             = 3
    healthy_threshold   = 2
    unhealthy_threshold = 2
  }
}

resource "aws_lb_listener_rule" "myalbrule" {
  listener_arn = aws_lb_listener.myhttp.arn
  priority     = 100

  condition {
    path_pattern {
      values = ["*"]
    }
  }

  action {
    type             = "forward"
    target_group_arn = aws_lb_target_group.myalbtg.arn
  }
}

output "myalb_dns" {
  value       = aws_lb.myalb.dns_name
  description = "The DNS Address of the ALB"
}
</span><span class="no">EOT
</span></code></pre></div></div> <h3 id="ë°°í¬-ì™„ë£Œ-í›„-curl-ì ‘ì†-í™•ì¸">ë°°í¬ ì™„ë£Œ í›„ curl ì ‘ì† í™•ì¸</h3> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë°°í¬</span>
terraform plan <span class="o">&amp;&amp;</span> terraform apply <span class="nt">-auto-approve</span>

<span class="c"># ALB DNSì£¼ì†Œë¡œ curl ì ‘ì† í™•ì¸ </span>
<span class="nv">ALBDNS</span><span class="o">=</span><span class="si">$(</span>terraform output <span class="nt">-raw</span> myalb_dns<span class="si">)</span>
<span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> http://<span class="nv">$ALBDNS</span>/ <span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>

<span class="c"># EC2 ìµœì†Œ 2ëŒ€ =&gt; 3ëŒ€ë¡œ ì¦ê°€ ìˆ˜ì •</span>
<span class="nb">sed</span> <span class="nt">-i</span> <span class="nt">-e</span> <span class="s1">'s/min_size = 2/min_size = 3/g'</span> asg.tf

<span class="c"># ë°°í¬</span>
terraform plan <span class="o">&amp;&amp;</span> terraform apply <span class="nt">-auto-approve</span>

<span class="c"># ALB DNSì£¼ì†Œë¡œ curl ì ‘ì† í™•ì¸ </span>
<span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> http://<span class="nv">$ALBDNS</span>/ <span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>

<span class="c"># ê°•ì œë¡œ EC2 1ëŒ€ ì‚­ì œ í›„ curl ì ‘ì† í™•ì¸ : ì¢…ë£Œ í™•ì¸ í›„ ì¹˜ë£Œë¥¼ ìœ„í•œ ì¸ì§€ê¹Œì§€ 3ë¶„ ì •ë„ ì‹œê°„ ì†Œìš” - (ìê°€ì¹˜ë£Œ) ì•Œì•„ì„œ 1ëŒ€ ì¶”ê°€</span>
</code></pre></div></div> <h3 id="ì‚­ì œ-terraform-destroy--auto-approve">ì‚­ì œ: <code class="language-plaintext highlighter-rouge">**terraform destroy -auto-approve**</code></h3> <ul> <li>destroy ëŠ” â€˜ì‹¤í–‰ ì·¨ì†Œ(undo)â€™ë¥¼ í•  ìˆ˜ ì—†ìœ¼ë‹ˆ, ì‹¤ì œ ìš´ì˜ í™˜ê²½ì—ì„œëŠ” ì£¼ì˜í•´ì„œ ì‹¤í–‰í•´ì•¼ í•¨</li> </ul> <div class="entry-meta"> <br> <hr> <span class="entry-tags"><a href="https://lahuman.github.io/tags/#terraform" title="Pages tagged terraform" class="tag"><span class="term">terraform</span></a><a href="https://lahuman.github.io/tags/#study" title="Pages tagged study" class="tag"><span class="term">study</span></a></span> <span class="social-share"> <a href="https://www.facebook.com/sharer/sharer.php?u=https://lahuman.github.io/t101_2week/" title="Share on Facebook" class="tag"> <span class="term"><i class="fa fa-facebook-square"></i> Share</span> </a> <a href="https://twitter.com/intent/tweet?text=https://lahuman.github.io/t101_2week/" title="Share on Twitter" class="tag"> <span class="term"><i class="fa fa-twitter-square"></i> Tweet</span> </a> <a href="https://plus.google.com/share?url=https://lahuman.github.io/t101_2week/" title="Share on Google+" class="tag"> <span class="term"><i class="fa fa-google-plus-square"></i> +1</span> </a> </span> <div style="clear:both"></div> </div> <ins class="kakao_ad_area" style="display:none;" data-ad-unit = "DAN-ubp67fs9s850" data-ad-width = "320" data-ad-height = "100"></ins> <script type="text/javascript" src="//t1.daumcdn.net/kas/static/ba.min.js" async></script> </div> </div> <section id="disqus_thread" class="animated fadeInUp"></section><!-- /#disqus_thread --> </header> <!-- JS --> <script src="https://lahuman.github.io/assets/js/jquery-1.12.0.min.js"></script> <script src="https://lahuman.github.io/assets/js/jquery.dlmenu.min.js"></script> <script src="https://lahuman.github.io/assets/js/jquery.goup.min.js"></script> <script src="https://lahuman.github.io/assets/js/jquery.magnific-popup.min.js"></script> <script src="https://lahuman.github.io/assets/js/jquery.fitvid.min.js"></script> <script src="https://lahuman.github.io/assets/js/scripts.js"></script> <!-- Global site tag (gtag.js) - Google Analytics --> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-74095083-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-74095083-1'); </script> <script type="text/javascript"> var disqus_shortname = 'daniels-blog'; (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); (function () { var s = document.createElement('script'); s.async = true; s.type = 'text/javascript'; s.src = '//' + disqus_shortname + '.disqus.com/count.js'; (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s); }()); </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> <!-- MathJax --> <script async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> </body> </html>
