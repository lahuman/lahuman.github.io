<!DOCTYPE html> <!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--> <!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8"><![endif]--> <!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9"><![endif]--> <!--[if gt IE 8]><!--> <html class="no-js"><!--<![endif]--> <head> <meta charset="UTF-8"> <meta content="text/html; charset=UTF-8" http-equiv="Content-Type"> <meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"> <title>Care Mate PoC 개발 &#8211; lahuman</title> <meta name="description" content="열심히 사는 아저씨"> <meta name="keywords" content="caremate, poc"> <!-- Twitter Cards --> <meta name="twitter:card" content="summary"> <meta name="twitter:image" content="https://lahuman.github.io/assets/img/logo.png"> <meta name="twitter:title" content="Care Mate PoC 개발"> <meta name="twitter:description" content="돌발 교통 상황, CCTV, 반려견 동반 위치 정보"> <!-- Open Graph --> <meta property="og:locale" content="ko_KR"> <meta property="og:type" content="article"> <meta property="og:title" content="Care Mate PoC 개발"> <meta property="og:description" content="돌발 교통 상황, CCTV, 반려견 동반 위치 정보"> <meta property="og:url" content="https://lahuman.github.io/care_mate/"> <meta property="og:site_name" content="lahuman"> <meta property="og:image" content="https://lahuman.github.io/assets/img/logo.png"> <link rel="canonical" href="https://lahuman.github.io/care_mate/"> <link href="https://lahuman.github.io/feed.xml" type="application/atom+xml" rel="alternate" title="lahuman Feed"> <!-- Handheld --> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- CSS --> <link rel="stylesheet" href="https://lahuman.github.io/assets/css/main.css"> <!-- JS --> <script src="https://lahuman.github.io/assets/js/modernizr-3.3.1.custom.min.js"></script> <!-- Favicons --> <link rel="apple-touch-icon" href="https://lahuman.github.io/assets/img/favicons/apple-icon-precomposed.png"> <link rel="apple-touch-icon" sizes="72x72" href="https://lahuman.github.io/assets/img/favicons/apple-icon-72x72.png"> <link rel="apple-touch-icon" sizes="114x114" href="https://lahuman.github.io/assets/img/favicons/apple-icon-114x114.png"> <link rel="apple-touch-icon" sizes="144x144" href="https://lahuman.github.io/assets/img/favicons/apple-icon-144x144.png"> <link rel="shortcut icon" type="image/png" href="https://lahuman.github.io/favicon.png" /> <link rel="shortcut icon" href="https://lahuman.github.io/favicon.ico" /> <!-- mermaid --> <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script> <script>mermaid.initialize({startOnLoad:true});</script> <!-- Background Image --> <style type="text/css">body {background-image:url(https://lahuman.github.io/assets/img/placeholder-big.jpg); background-repeat: no-repeat; background-size: cover; }</style> <!-- Post Feature Image --> </head> <body> <nav id="dl-menu" class="dl-menuwrapper" role="navigation"> <button class="dl-trigger">Open Menu</button> <ul class="dl-menu"> <li><a href="https://lahuman.github.io/">Home</a></li> <li> <a href="#">About</a> <ul class="dl-submenu"> <li> <img src="https://lahuman.github.io/assets/img/logo.png" alt="lahuman photo" class="author-photo"> <h4>lahuman</h4> <p>열심히 사는 아저씨</p> </li> <li><a href="https://lahuman.github.io/about/"><span class="btn btn-inverse">Learn More</span></a></li> <li> <a href="http://facebook.com/lahuman" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-facebook-square"></i> Facebook</a> </li> <li> <a href="http://linkedin.com/in/lahuman" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-linkedin-square"></i> LinkedIn</a> </li> <li> <a href="http://github.com/lahuman" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-github"></i> Github</a> </li> </ul><!-- /.dl-submenu --> </li> <li> <a href="#">Posts</a> <ul class="dl-submenu"> <li><a href="https://lahuman.github.io/posts/">All Posts</a></li> <li><a href="https://lahuman.github.io/tags/">All Tags</a></li> </ul> </li> <li><a href="https://lahuman.github.io/projects/" >Projects</a></li> </ul><!-- /.dl-menu --> </nav><!-- /.dl-menuwrapper --> <!-- Header --> <header class="header" role="banner"> <div class="wrapper animated fadeIn"> <div class="content"> <div class="post-title "> <h1>Care Mate PoC 개발</h1> <h4>13 Nov 2024</h4> <p class="reading-time"> <i class="fa fa-clock-o"></i> Reading time ~3 minutes </p><!-- /.entry-reading-time --> <a class="btn zoombtn" href="https://lahuman.github.io/projects/"> <i class="fa fa-chevron-left"></i> </a> </div> <h1 id="주변-돌발-교통-상황-정보-제공-poc">주변 돌발 교통 상황 정보 제공 PoC</h1> <p>회사에서 진행하는 러닝크루(학습 크루) 에서 동료를 모아 <a href="https://www.mycaremate.co.kr/">Care Mate</a>라는 프로젝트를 진행했습니다.</p> <p>프로젝트의 초기 PoC 단계를 빠르게 구현해보았습니다.</p> <p><a href="https://github.com/lahuman/traffic-alert">프로젝트 바로 가기</a></p> <p><a href="https://t-a.duckdns.org/">데모사이트 바로 가기</a></p> <h2 id="개요">개요</h2> <p>이 프로젝트는 사용자가 지정한 위치 근처의 교통 사고에 대한 알림을 제공하기 위해 설계되었습니다. 시스템은 외부 소스로부터 교통 사고 데이터를 가져와 이를 처리하고, 지리 공간 데이터를 지원하는 PostGIS 확장 기능을 사용하는 PostgreSQL 데이터베이스에 저장합니다. 서버는 이 데이터를 API를 통해 제공하며, 사용자는 근처의 사고를 조회할 수 있습니다.</p> <h2 id="주요-기능">주요 기능</h2> <ul> <li><strong>실시간 교통 사고 데이터</strong>: 시스템은 외부 소스로부터 5분마다 교통 사고 데이터를 가져옵니다.</li> <li><strong>지리 공간 데이터 처리</strong>: PostGIS 확장 기능을 사용하는 PostgreSQL을 활용하여 지리 공간 데이터를 저장하고, 근접 기반 검색을 효율적으로 수행할 수 있습니다.</li> <li><strong>보안된 API 접근</strong>: API는 헤더에 <code class="highlighter-rouge">authkey</code>를 요구하며, 이를 통해 인증된 사용자만 교통 데이터를 조회할 수 있습니다.</li> <li><strong>도커 기반 설정</strong>: PostgreSQL과 PostGIS는 Docker를 이용해 컨테이너화되어 있어 배포와 관리가 용이합니다.</li> <li><strong>PM2 프로세스 관리</strong>: 서버와 스케줄링 작업은 PM2로 관리되어 신뢰성 있는 작동과 모니터링이 가능합니다.</li> </ul> <h2 id="시스템-구조">시스템 구조</h2> <ul> <li><strong>Docker</strong>: PostgreSQL과 PostGIS는 Docker 컨테이너에서 실행되어 일관된 격리 환경을 유지합니다.</li> <li><strong>Node.js</strong>: 애플리케이션 백엔드는 Node.js와 Express로 구축되었습니다. <ul> <li><strong>index.js</strong>: 근접 기반의 교통 사고 데이터를 제공하는 API 요청을 처리합니다.</li> <li><strong>schedule.js</strong>: 5분마다 교통 데이터를 가져와 데이터베이스를 갱신합니다.</li> </ul> </li> <li><strong>PM2</strong>: Node.js 프로세스를 관리하여 서버(<code class="highlighter-rouge">index.js</code>)와 스케줄러(<code class="highlighter-rouge">schedule.js</code>)가 항상 실행되도록 하고, 장애 발생 시 자동으로 재시작합니다.</li> </ul> <h2 id="사전-준비-사항">사전 준비 사항</h2> <ul> <li>Docker</li> <li>Node.js</li> <li>PM2</li> </ul> <h2 id="설정-및-설치">설정 및 설치</h2> <h3 id="1-저장소-클론">1. 저장소 클론</h3> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/lahuman/traffic-alert.git
<span class="nb">cd </span>traffic-alert
</code></pre></div></div> <h3 id="2-환경-변수-설정">2. 환경 변수 설정</h3> <p>프로젝트 루트 디렉토리에 <code class="highlighter-rouge">_env</code>를 <code class="highlighter-rouge">.env</code> 파일로 변경하고 다음 변수를 추가합니다:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">DB_HOST</span><span class="o">=</span>your_postgres_host
<span class="nv">DB_PORT</span><span class="o">=</span>your_postgres_port
<span class="nv">DB_DB</span><span class="o">=</span>your_database_name
<span class="nv">DB_USER</span><span class="o">=</span>your_database_user
<span class="nv">DB_PW</span><span class="o">=</span>your_database_password
<span class="nv">TRAFFIC_TOKEN</span><span class="o">=</span>your_traffic_api_token
<span class="nv">WALK_TOKEN</span><span class="o">=</span>your_walk_api_token
<span class="nv">AUTH_KEY</span><span class="o">=</span>your_api_token
<span class="c"># 반경 M 조회 기준</span>
<span class="nv">WALK_RADIUS</span><span class="o">=</span>50
<span class="nv">TRAFFIC_RADIUS</span><span class="o">=</span>500
</code></pre></div></div> <h3 id="3-docker를-이용한-postgresql과-postgis-시작">3. Docker를 이용한 PostgreSQL과 PostGIS 시작</h3> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">--name</span> some-postgis <span class="nt">-p</span> 5432:5432 <span class="nt">-e</span> <span class="nv">POSTGRES_PASSWORD</span><span class="o">=</span>mysecretpassword <span class="nt">-d</span> postgis/postgis
</code></pre></div></div> <p>이 명령어는 PostgreSQL과 PostGIS 컨테이너를 시작합니다.</p> <h3 id="4-nodejs-의존성-설치">4. Node.js 의존성 설치</h3> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm install
</code></pre></div></div> <h3 id="5-데이터베이스-초기화">5. 데이터베이스 초기화</h3> <p>PostgreSQL 컨테이너에 접속하여 PostGIS 확장을 초기화합니다</p> <p><code class="highlighter-rouge">/data/initial.sql</code> 의 SQL을 실행해서 초기 테이블 구성 및 데이터를 적재합니다.</p> <h3 id="6-애플리케이션-시작">6. 애플리케이션 시작</h3> <p>PM2를 사용하여 서버와 스케줄러를 시작합니다:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pm2 start <span class="s2">"npm run start"</span> <span class="nt">--name</span> traffic-server
pm2 start <span class="s2">"npm run t-schedule"</span> <span class="nt">--name</span> traffic-scheduler <span class="nt">--cron</span> <span class="s2">"*/5 * * * *"</span>
<span class="c"># 1회만 실행</span>
npm run w-schedule
</code></pre></div></div> <p>이 명령은 다음을 시작합니다:</p> <ul> <li><code class="highlighter-rouge">index.js</code>: API 요청을 처리하는 서버.</li> <li><code class="highlighter-rouge">schedule.js</code>: 5분마다 교통 데이터를 가져와 갱신하는 스크립트.</li> </ul> <h3 id="7-애플리케이션-모니터링-및-관리">7. 애플리케이션 모니터링 및 관리</h3> <p>PM2를 사용하여 프로세스를 모니터링하고 관리할 수 있습니다:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pm2 list
pm2 logs
pm2 restart traffic-server
pm2 restart traffic-scheduler
</code></pre></div></div> <h2 id="사용법">사용법</h2> <h3 id="api-엔드포인트">API 엔드포인트</h3> <ul> <li> <p><strong>GET /traffic-alert?lat={latitude}&amp;lon={longitude}</strong></p> <p>이 엔드포인트는 지정된 위도와 경도 근처의 교통 사고를 반환합니다.</p> </li> </ul> <h3 id="도로-돌발-상황">도로 돌발 상황</h3> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-X</span> GET <span class="s2">"http://localhost:3000/traffic-alert?lat=37.4959854&amp;lon=126.8879636"</span> <span class="nt">-H</span> <span class="s2">"authkey: AUTH_KEY"</span>
</code></pre></div></div> <h4 id="응답-예제">응답 예제</h4> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"incident_123"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"address"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Guro-gu, Seoul"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Traffic accident on the main road"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"type_cd"</span><span class="p">:</span><span class="w"> </span><span class="s2">"accident"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"sub_cd"</span><span class="p">:</span><span class="w"> </span><span class="s2">"collision"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"latitude"</span><span class="p">:</span><span class="w"> </span><span class="mf">37.4959854</span><span class="p">,</span><span class="w">
    </span><span class="s2">"longitude"</span><span class="p">:</span><span class="w"> </span><span class="mf">126.8879636</span><span class="p">,</span><span class="w">
    </span><span class="s2">"start_dtm"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2023-09-01 10:00"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"end_dtm"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2023-09-01 12:00"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"update_dtm"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2023-09-01 10:05"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div></div> <h3 id="보행자-사고-다발-지역">보행자 사고 다발 지역</h3> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-X</span> GET <span class="s2">"http://localhost:3000/traffic-alert?lat=37.4959854&amp;lon=126.8879636"</span> <span class="nt">-H</span> <span class="s2">"authkey: AUTH_KEY"</span>
</code></pre></div></div> <h4 id="응답-예제-1">응답 예제</h4> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="s2">"distance"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
    </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">6779261</span><span class="p">,</span><span class="w">
    </span><span class="s2">"address"</span><span class="p">:</span><span class="w"> </span><span class="s2">"서울특별시 강남구 청담동(강남구청역사거리 부근)"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"year"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2021"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"occxrrnc_cnt"</span><span class="p">:</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w">
    </span><span class="s2">"latitude"</span><span class="p">:</span><span class="w"> </span><span class="mf">37.517132005639</span><span class="p">,</span><span class="w">
    </span><span class="s2">"longitude"</span><span class="p">:</span><span class="w"> </span><span class="mf">127.040862919289</span><span class="p">,</span><span class="w">
    </span><span class="s2">"reg_dtm"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-09-02T21:11:22.537Z"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div></div> <h3 id="지도로-확인하는-특별-교통-정보">지도로 확인하는 특별 교통 정보</h3> <p>API 서버 실행 후, <code class="highlighter-rouge">http://localhost:3000/map</code> 으로 접근하면 아래와 같은 지도를 확인 할 수 있습니다</p> <p><img src="/screenshot.png" alt="" /></p> <p>지도 중심에서 5KM 반경으로 특별 교통 정보를 표기 합니다. 반경은 원으로 표기 하여 알 수 있게 합니다.</p> <h2 id="데모-사이트-접근">데모 사이트 접근</h2> <p>https://t-a.duckdns.org/</p> <h2 id="기여하기">기여하기</h2> <p>이 프로젝트에 기여하고 싶다면, 저장소를 포크한 후 풀 리퀘스트를 제출해주세요. 모든 기여를 환영합니다!</p> <h2 id="라이선스">라이선스</h2> <p>이 프로젝트는 MIT 라이선스로 라이선스가 부여되어 있습니다.</p> <h2 id="참고-자료">참고 자료</h2> <ul> <li><a href="https://www.utic.go.kr/map/map.do?menu=incident&amp;x=127.028&amp;y=37.263">도시교통정보센터-돌발정보</a></li> <li><a href="https://opendata.koroad.or.kr/api/selectPedstriansDataSet.do">보행자 사고다발지역 API</a></li> <li><a href="https://registry.hub.docker.com/r/postgis/postgis/">docker-postgis</a></li> <li><a href="https://github.com/mratanusarkar/NodeJS-ProgressBar">NodeJS-ProgressBar</a></li> <li><a href="https://www.openstreetmap.org/">openstreetmap</a></li> <li><a href="https://project-osrm.org/">OSRM</a></li> <li><a href="https://www.data.go.kr/data/15111389/fileData.do?recommendDataYn=Y">한국문화정보원_전국 반려동물 동반 가능 문화시설 위치 데이터</a></li> </ul> <div class="entry-meta"> <br> <hr> <span class="entry-tags"><a href="https://lahuman.github.io/tags/#caremate" title="Pages tagged caremate" class="tag"><span class="term">caremate</span></a><a href="https://lahuman.github.io/tags/#poc" title="Pages tagged poc" class="tag"><span class="term">poc</span></a></span> <span class="social-share"> <a href="https://www.facebook.com/sharer/sharer.php?u=https://lahuman.github.io/care_mate/" title="Share on Facebook" class="tag"> <span class="term"><i class="fa fa-facebook-square"></i> Share</span> </a> <a href="https://twitter.com/intent/tweet?text=https://lahuman.github.io/care_mate/" title="Share on Twitter" class="tag"> <span class="term"><i class="fa fa-twitter-square"></i> Tweet</span> </a> <a href="https://plus.google.com/share?url=https://lahuman.github.io/care_mate/" title="Share on Google+" class="tag"> <span class="term"><i class="fa fa-google-plus-square"></i> +1</span> </a> </span> <div style="clear:both"></div> </div> <ins class="kakao_ad_area" style="display:none;" data-ad-unit = "DAN-ubp67fs9s850" data-ad-width = "320" data-ad-height = "100"></ins> <script type="text/javascript" src="//t1.daumcdn.net/kas/static/ba.min.js" async></script> </div> </div> <section id="disqus_thread" class="animated fadeInUp"></section><!-- /#disqus_thread --> </header> <!-- JS --> <script src="https://lahuman.github.io/assets/js/jquery-1.12.0.min.js"></script> <script src="https://lahuman.github.io/assets/js/jquery.dlmenu.min.js"></script> <script src="https://lahuman.github.io/assets/js/jquery.goup.min.js"></script> <script src="https://lahuman.github.io/assets/js/jquery.magnific-popup.min.js"></script> <script src="https://lahuman.github.io/assets/js/jquery.fitvid.min.js"></script> <script src="https://lahuman.github.io/assets/js/scripts.js"></script> <!-- Global site tag (gtag.js) - Google Analytics --> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-74095083-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-74095083-1'); </script> <script type="text/javascript"> var disqus_shortname = 'daniels-blog'; (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); (function () { var s = document.createElement('script'); s.async = true; s.type = 'text/javascript'; s.src = '//' + disqus_shortname + '.disqus.com/count.js'; (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s); }()); </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> <!-- MathJax --> <script async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> </body> </html>
