<!DOCTYPE html> <!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--> <!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8"><![endif]--> <!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9"><![endif]--> <!--[if gt IE 8]><!--> <html class="no-js"><!--<![endif]--> <head> <meta charset="UTF-8"> <meta content="text/html; charset=UTF-8" http-equiv="Content-Type"> <meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"> <title>#1 컨테이너 격리 &#8211; lahuman</title> <meta name="description" content="열심히 사는 아저씨"> <meta name="keywords" content="kang, vagrant, docker"> <!-- Twitter Cards --> <meta name="twitter:card" content="summary"> <meta name="twitter:image" content="https://lahuman.github.io/assets/img/logo.png"> <meta name="twitter:title" content="#1 컨테이너 격리"> <meta name="twitter:description" content="Kubernetes Advanced Networking Study"> <!-- Open Graph --> <meta property="og:locale" content="ko_KR"> <meta property="og:type" content="article"> <meta property="og:title" content="#1 컨테이너 격리"> <meta property="og:description" content="Kubernetes Advanced Networking Study"> <meta property="og:url" content="https://lahuman.github.io/kang_1week_1/"> <meta property="og:site_name" content="lahuman"> <meta property="og:image" content="https://lahuman.github.io/assets/img/logo.png"> <link rel="canonical" href="https://lahuman.github.io/kang_1week_1/"> <link href="https://lahuman.github.io/feed.xml" type="application/atom+xml" rel="alternate" title="lahuman Feed"> <!-- Handheld --> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- CSS --> <link rel="stylesheet" href="https://lahuman.github.io/assets/css/main.css"> <!-- JS --> <script src="https://lahuman.github.io/assets/js/modernizr-3.3.1.custom.min.js"></script> <!-- Favicons --> <link rel="apple-touch-icon" href="https://lahuman.github.io/assets/img/favicons/apple-icon-precomposed.png"> <link rel="apple-touch-icon" sizes="72x72" href="https://lahuman.github.io/assets/img/favicons/apple-icon-72x72.png"> <link rel="apple-touch-icon" sizes="114x114" href="https://lahuman.github.io/assets/img/favicons/apple-icon-114x114.png"> <link rel="apple-touch-icon" sizes="144x144" href="https://lahuman.github.io/assets/img/favicons/apple-icon-144x144.png"> <link rel="shortcut icon" type="image/png" href="https://lahuman.github.io/favicon.png" /> <link rel="shortcut icon" href="https://lahuman.github.io/favicon.ico" /> <!-- mermaid --> <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script> <script>mermaid.initialize({startOnLoad:true});</script> <!-- Background Image --> <style type="text/css">body {background-image:url(https://lahuman.github.io/assets/img/placeholder-big.jpg); background-repeat: no-repeat; background-size: cover; }</style> <!-- Post Feature Image --> </head> <body> <nav id="dl-menu" class="dl-menuwrapper" role="navigation"> <button class="dl-trigger">Open Menu</button> <ul class="dl-menu"> <li><a href="https://lahuman.github.io/">Home</a></li> <li> <a href="#">About</a> <ul class="dl-submenu"> <li> <img src="https://lahuman.github.io/assets/img/logo.png" alt="lahuman photo" class="author-photo"> <h4>lahuman</h4> <p>열심히 사는 아저씨</p> </li> <li><a href="https://lahuman.github.io/about/"><span class="btn btn-inverse">Learn More</span></a></li> <li> <a href="http://facebook.com/lahuman" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-facebook-square"></i> Facebook</a> </li> <li> <a href="http://linkedin.com/in/lahuman" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-linkedin-square"></i> LinkedIn</a> </li> <li> <a href="http://github.com/lahuman" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-github"></i> Github</a> </li> </ul><!-- /.dl-submenu --> </li> <li> <a href="#">Posts</a> <ul class="dl-submenu"> <li><a href="https://lahuman.github.io/posts/">All Posts</a></li> <li><a href="https://lahuman.github.io/tags/">All Tags</a></li> </ul> </li> <li><a href="https://lahuman.github.io/projects/" >Projects</a></li> </ul><!-- /.dl-menu --> </nav><!-- /.dl-menuwrapper --> <!-- Header --> <header class="header" role="banner"> <div class="wrapper animated fadeIn"> <div class="content"> <div class="post-title "> <h1>#1 컨테이너 격리</h1> <h4>13 Jan 2022</h4> <p class="reading-time"> <i class="fa fa-clock-o"></i> Reading time ~17 minutes </p><!-- /.entry-reading-time --> <a class="btn zoombtn" href="https://lahuman.github.io/projects/"> <i class="fa fa-chevron-left"></i> </a> </div> <h1 id="컨테이너-격리--도커-네트워크">컨테이너 격리 &amp; 도커 네트워크</h1> <blockquote> <p>Kubernetes Advanced Networking Study(이하 KANG) 첫번째 시간에 내용을 정리 하였습니다.</p> </blockquote> <h2 id="도커docker란">도커(Docker)란?</h2> <p>도커(Docker)는 <code class="highlighter-rouge">가상실행 환경</code>을 제공해주는 오픈소스 플랫폼입니다. 도커에서는 이 가상실행 환경을 <code class="highlighter-rouge">컨테이너(Container)</code>라고 부릅니다.</p> <ul> <li>정확히 표현하는 용어는 ‘컨테이너화된 프로세스(Containerized Process)’</li> <li>도커 플랫폼이 설치된 곳이라면 컨테이너로 묶인 애플리케이션을 어디서든 실행할 수 있음</li> </ul> <p><img src="/assets/img/post_img/docker.png" alt="[https://kubernetes.io/docs/concepts/overview/what-is-kubernetes/](https://kubernetes.io/docs/concepts/overview/what-is-kubernetes/)" /></p> <h3 id="컨테이너-vs-virtual-machinevm">컨테이너 VS Virtual Machine(VM)</h3> <blockquote> <p><code class="highlighter-rouge">hypervisor를 이용한 Virtual Machine</code> 과 <code class="highlighter-rouge">프로세스를 이용한 컨테이너의</code> 차이를 비교 합니다.</p> </blockquote> <p><img src="/assets/img/post_img/vm-container.png" alt="출처 : KANG" /></p> <p><code class="highlighter-rouge">컨테이너</code>는 운영체제를 제외한 나머지 애플리케이션 실행에 필요한 모든 파일을 패키징한다는 점에서 <code class="highlighter-rouge">OS레벨 가상화</code>를 지원하는 <code class="highlighter-rouge">1개 이상의 프로세스 세트</code>입니다 컨테이너는 <code class="highlighter-rouge">프로세스</code>가 <code class="highlighter-rouge">지정된 리소스 요청에만 액세스할 수 있도록 허용</code>합니다. 이러한 리소스 제한은 컨테이너가 용량이 충분한 노드에서 구동될 수 있도록 합니다.</p> <ul> <li>컨테이너는 호스트의 커널을 공유하지만, 개별적인 <strong>‘사용자 공간(user space)’</strong> 를 가집니다.</li> <li>가상화된 공간을 생성하기 위해 리눅스 기능 <code class="highlighter-rouge">pivot-root</code>, <code class="highlighter-rouge">네임스페이스(namespace)</code>, <code class="highlighter-rouge">cgroup</code> 를 사용함으로써 프로세스 단위의 격리 환경과 리소스을 제공합니다.</li> </ul> <p><img src="/assets/img/post_img/locationOfFunctionality.png" alt="출처 : KANG" /></p> <p><code class="highlighter-rouge">VM</code>은 <code class="highlighter-rouge">자체 운영 체제(Operating System, OS)를 포함</code>하고 있어 여러 리소스 집약적인 기능을 한 번에 수행할 수 있습니다. VM에서 사용할 수 있는 리소스가 늘어남에 따라 전체 서버, OS, 데스크톱, 데이터베이스, 네트워크를 추상화, 분할, 복제, 에뮬레이션할 수 있습니다.</p> <ul> <li>개별 VM은 독립된 OS를 사용하여 컨테이너 방식에 비해 고립성(보안)은 더 좋지만, 오버헤드가 크고 무겁고 느리다는 단점을 가짐</li> </ul> <blockquote> <p><code class="highlighter-rouge">컨테이너</code>와 <code class="highlighter-rouge">VM</code>은 유사하다고 볼 수 있습니다. 중요한 차이점은 <code class="highlighter-rouge">확장 방식</code>과 <code class="highlighter-rouge">이식성</code>입니다. <code class="highlighter-rouge">컨테이너</code>는 <code class="highlighter-rouge">게스트OS</code> 와 <code class="highlighter-rouge">하이버파이저</code>가 없기 때문에 이로 인한 <code class="highlighter-rouge">오버헤드를 줄임</code>으로써 <code class="highlighter-rouge">훨씬 더 가볍게 프로세스를 실행</code>할 수 있고 컨테이너에 대한 복제와 배포가 더 용이합니다.</p> </blockquote> <h3 id="docker-아키텍처">docker 아키텍처</h3> <p><img src="/assets/img/post_img/docker-architecure.png" alt="[docker-architecture](https://docs.docker.com/get-started/overview/#docker-architecture)" /></p> <h2 id="1-vagrant로-docker-사용해보기">#1 vagrant로 docker 사용해보기</h2> <p>작업을 시작하려고 하는 빈 디렉토리에서 아래 파일을 생성합니다.</p> <ul> <li><code class="highlighter-rouge">Vagrantfile</code> 파일</li> </ul> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="s2">"2"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">boot_timeout</span> <span class="o">=</span> <span class="mi">1800</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box</span> <span class="o">=</span> <span class="s2">"ubuntu/focal64"</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box_version</span> <span class="o">=</span> <span class="s2">"20211026.0.0"</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">inline: </span><span class="s2">"echo 'sudo su -' &gt;&gt; .bashrc"</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">inline: </span><span class="s2">"apt update"</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">inline: </span><span class="s2">"apt install -y conntrack bridge-utils net-tools resolvconf jq tree"</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">inline: </span><span class="s2">"echo 'nameserver 8.8.8.8' &gt; /etc/resolvconf/resolv.conf.d/head"</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">inline: </span><span class="s2">"resolvconf -u"</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"private_network"</span><span class="p">,</span> <span class="ss">ip: </span><span class="s2">"192.168.50.10"</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"forwarded_port"</span><span class="p">,</span> <span class="ss">guest: </span><span class="mi">22</span><span class="p">,</span> <span class="ss">host: </span><span class="mi">60510</span><span class="p">,</span> <span class="ss">auto_correct: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">id: </span><span class="s2">"ssh"</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">synced_folder</span> <span class="s2">"./"</span><span class="p">,</span> <span class="s2">"/vagrant"</span><span class="p">,</span> <span class="ss">disabled: </span><span class="kp">true</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="s2">"virtualbox"</span> <span class="k">do</span> <span class="o">|</span><span class="n">spec</span><span class="o">|</span>
    <span class="n">spec</span><span class="p">.</span><span class="nf">memory</span> <span class="o">=</span> <span class="s2">"2048"</span>
    <span class="n">spec</span><span class="p">.</span><span class="nf">cpus</span> <span class="o">=</span> <span class="s2">"2"</span>
    <span class="n">spec</span><span class="p">.</span><span class="nf">linked_clone</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="n">spec</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span> <span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--uartmode1"</span><span class="p">,</span> <span class="s2">"disconnected"</span> <span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p>준비가 되었으면, <code class="highlighter-rouge">vagrant</code> 명령어로 VM을 실행합니다.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># vagrant 프로비저닝</span>
<span class="nv">$ </span>vagrant up

<span class="c"># Ubuntu SSH 접속</span>
<span class="nv">$ </span>vagrant ssh

<span class="nt">-----------</span>
<span class="c"># Ubuntu Shell 에서 Ubuntu 종료</span>
<span class="nv">$ </span>poweroff
<span class="nt">-----------</span>

<span class="c"># Ubuntu 재시작 후 Ubuntu SSH 접속</span>
<span class="nv">$ </span>vagrant reload
<span class="nv">$ </span>vagrant ssh

</code></pre></div></div> <blockquote> <p><code class="highlighter-rouge">프로비저닝(provisioning)</code>은 사용자의 요구에 맞게 시스템 자원을 할당, 배치, 배포해 두었다가 필요 시 시스템을 즉시 사용할 수 있는 상태로 미리 준비해 두는 것을 말한다. 서버 자원 프로비저닝, OS 프로비저닝, 소프트웨어 프로비저닝, 스토리지 프로비저닝, 계정 프로비저닝 등이 있다. 수동으로 처리하는 ‘수동 프로비저닝’과 자동화 툴을 이용해 처리하는 ‘자동 프로비저닝’이 있다</p> </blockquote> <h3 id="추가-tip">추가 TIP</h3> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lahuman@HP:/mnt/c/Users/lahum/projects/KANS/1week/1.docker<span class="nv">$ </span>vagrant reload
<span class="o">==&gt;</span> default: Checking <span class="k">if </span>box <span class="s1">'ubuntu/focal64'</span> version <span class="s1">'20211026.0.0'</span> is up to date...
<span class="o">==&gt;</span> default: Clearing any previously <span class="nb">set </span>forwarded ports...
<span class="o">==&gt;</span> default: Clearing any previously <span class="nb">set </span>network interfaces...
<span class="o">==&gt;</span> default: Preparing network interfaces based on configuration...
    default: Adapter 1: nat
    default: Adapter 2: hostonly
<span class="o">==&gt;</span> default: Forwarding ports...
    default: 22 <span class="o">(</span>guest<span class="o">)</span> <span class="o">=&gt;</span> 60510 <span class="o">(</span>host<span class="o">)</span> <span class="o">(</span>adapter 1<span class="o">)</span>
<span class="o">==&gt;</span> default: Running <span class="s1">'pre-boot'</span> VM customizations...
<span class="o">==&gt;</span> default: Booting VM...
<span class="o">==&gt;</span> default: Waiting <span class="k">for </span>machine to boot. This may take a few minutes...
    default: SSH address: 172.29.0.1:60510
    default: SSH username: vagrant
    default: SSH auth method: private key
Timed out <span class="k">while </span>waiting <span class="k">for </span>the machine to boot. This means that
Vagrant was unable to communicate with the guest machine within
the configured <span class="o">(</span><span class="s2">"config.vm.boot_timeout"</span> value<span class="o">)</span> <span class="nb">time </span>period.

If you look above, you should be able to see the error<span class="o">(</span>s<span class="o">)</span> that
Vagrant had when attempting to connect to the machine. These errors
are usually good hints as to what may be wrong.

If you<span class="s1">'re using a custom box, make sure that networking is properly
working and you'</span>re able to connect to the machine. It is a common
problem that networking isn<span class="s1">'t setup properly in these boxes.
Verify that authentication configurations are also setup properly,
as well.

If the box appears to be booting properly, you may want to increase
the timeout ("config.vm.boot_timeout") value.
</span></code></pre></div></div> <p>위와 같이 <code class="highlighter-rouge">timout</code>이 발생하여서 다시 기동시에 <code class="highlighter-rouge">reload</code>를 하지 말고 <code class="highlighter-rouge">up</code>으로 요청하면 VM 서버를 재기동 하지 않고 연결합니다.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># VM이 재기동 되어 오랜 시간이 걸림</span>
lahuman@HP:/mnt/c/Users/lahum/projects/KANS/1week/1.docker<span class="nv">$ </span>vagrant reload
<span class="o">==&gt;</span> default: Attempting graceful shutdown of VM...
<span class="o">==&gt;</span> default: Checking <span class="k">if </span>box <span class="s1">'ubuntu/focal64'</span> version <span class="s1">'20211026.0.0'</span> is up to date...
<span class="o">==&gt;</span> default: Clearing any previously <span class="nb">set </span>forwarded ports...
<span class="o">==&gt;</span> default: Clearing any previously <span class="nb">set </span>network interfaces...
<span class="o">==&gt;</span> default: Preparing network interfaces based on configuration...
    default: Adapter 1: nat
    default: Adapter 2: hostonly
<span class="o">==&gt;</span> default: Forwarding ports...
    default: 22 <span class="o">(</span>guest<span class="o">)</span> <span class="o">=&gt;</span> 60510 <span class="o">(</span>host<span class="o">)</span> <span class="o">(</span>adapter 1<span class="o">)</span>
<span class="o">==&gt;</span> default: Running <span class="s1">'pre-boot'</span> VM customizations...
<span class="o">==&gt;</span> default: Booting VM...
<span class="o">==&gt;</span> default: Waiting <span class="k">for </span>machine to boot. This may take a few minutes...
    default: SSH address: 172.29.0.1:60510
    default: SSH username: vagrant
    default: SSH auth method: private key
    default: Warning: Connection reset. Retrying...
<span class="o">==&gt;</span> default: Machine booted and ready!
<span class="o">==&gt;</span> default: Checking <span class="k">for </span>guest additions <span class="k">in </span>VM...
<span class="o">==&gt;</span> default: Configuring and enabling network interfaces...
<span class="o">==&gt;</span> default: Machine already provisioned. Run <span class="sb">`</span>vagrant provision<span class="sb">`</span> or use the <span class="sb">`</span><span class="nt">--provision</span><span class="sb">`</span>
<span class="o">==&gt;</span> default: flag to force provisioning. Provisioners marked to run always will still run.

<span class="c"># VM 기동 완료되어서 바로 시작</span>
lahuman@HP:/mnt/c/Users/lahum/projects/KANS/1week/1.docker<span class="nv">$ </span>vagrant up
Bringing machine <span class="s1">'default'</span> up with <span class="s1">'virtualbox'</span> provider...
<span class="o">==&gt;</span> default: Checking <span class="k">if </span>box <span class="s1">'ubuntu/focal64'</span> version <span class="s1">'20211026.0.0'</span> is up to date...
<span class="o">==&gt;</span> default: Machine already provisioned. Run <span class="sb">`</span>vagrant provision<span class="sb">`</span> or use the <span class="sb">`</span><span class="nt">--provision</span><span class="sb">`</span>
<span class="o">==&gt;</span> default: flag to force provisioning. Provisioners marked to run always will still run.
</code></pre></div></div> <h3 id="virtualbox-네트워크-구성-정보">Virtualbox 네트워크 구성 정보</h3> <h4 id="host-pc에서-ssh-접근시">Host PC에서 ssh 접근시</h4> <p><img src="/assets/img/post_img/vm-network.png" alt="출처 : KANG" /></p> <p>vagrant ssh 접속 시 기본적으로 호스트에 127.0.0.1(60510)를 목적지로 접속 → 이후 포트포워딩(SNAT + DNAT)을 통해서 내부에 VM로 SSH 연결됨</p> <p><img src="/assets/img/post_img/vm-network-setting.png" alt="vm network 설정 정보" /></p> <h4 id="ubuntu에서-외부-인터넷-접속시">Ubuntu에서 외부 인터넷 접속시</h4> <p><img src="/assets/img/post_img/vm-network-internet.png" alt="출처 : KANG" /></p> <h3 id="docker-설치">docker 설치</h3> <p>다음 명령어로 docker를 설치합니다.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 도커 설치</span>
<span class="nv">$ </span>curl <span class="nt">-fsSL</span> https://get.docker.com | sh

<span class="c"># 도커 정보 확인</span>
<span class="nv">$ </span>docker info
<span class="nv">$ </span>docker version

<span class="c"># 도커 서비스 상태 확인</span>
<span class="nv">$ </span>systemctl status docker
<span class="c"># 'q' 입력으로 빠져나오기</span>

<span class="c"># 모든 서비스의 상태 표시 - 링크</span>
<span class="nv">$ </span>systemctl list-units <span class="nt">--type</span><span class="o">=</span>service

<span class="c"># 도커 루트 디렉터리 확인</span>
<span class="nv">$ </span>tree <span class="nt">-L</span> 3 /var/lib/docker
<span class="c"># 결과</span>
/var/lib/docker
├── buildkit
│   ├── cache.db
│   ├── containerdmeta.db
│   ├── content
│   │   └── ingest
│   ├── executor
│   ├── metadata_v2.db
│   └── snapshots.db
├── containers
├── image
│   └── overlay2
│       ├── distribution
│       ├── imagedb
│       ├── layerdb
│       └── repositories.json
├── network
│   └── files
│       └── local-kv.db
├── overlay2
│   └── l
├── plugins
│   ├── storage
│   │   └── ingest
│   └── tmp
├── runtimes
├── swarm
├── tmp
├── trust
└── volumes
    ├── backingFsBlockDev
    └── metadata.db

23 directories, 8 files
</code></pre></div></div> <h3 id="docker-설치-후-기본-정보-확인">docker 설치 후 기본 정보 확인</h3> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 프로세스 확인 - 셸변수</span>
<span class="nv">$ </span>ps <span class="nt">-ef</span>
<span class="nv">$ </span>pstree <span class="nt">-p</span>

<span class="c"># 시스템에 (마운트 된) disk free 디스크 여유 공간 확인</span>
<span class="nv">$ </span>df <span class="nt">-hT</span>

<span class="c"># 네트워크 정보 확인 &gt;&gt; docker0 네트워크 인터페이스가 추가됨, 현재는 DOWN 상태</span>
<span class="nv">$ </span>ip <span class="nt">-br</span> <span class="nt">-c</span> addr
<span class="nv">$ </span>ip <span class="nt">-c</span> addr
<span class="nv">$ </span>ip <span class="nt">-c</span> link
<span class="nv">$ </span>ip <span class="nt">-br</span> <span class="nt">-c</span> link
<span class="nv">$ </span>ip <span class="nt">-c</span> route

<span class="c"># 이더넷 브리지 정보 확인</span>
<span class="nv">$ </span>brctl show

<span class="c"># iptables 정책 확인</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> filter <span class="nt">-S</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span>
</code></pre></div></div> <p><code class="highlighter-rouge">iptables</code> 명령어의 결과를 자세히 보면, docker를 설치하기 전과 후가 다릅니다.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># filter 에 FORWARD 가 기존 ACCEPT 에서 DROP 로 변경됨</span>
<span class="c"># filter 에 FORWARD 에 docker0 에서 docker0 혹은 외부로 전달 허용 정책이 추가됨</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> filter <span class="nt">-S</span>
<span class="nt">-P</span> INPUT ACCEPT
<span class="nt">-P</span> FORWARD DROP
<span class="nt">-P</span> OUTPUT ACCEPT
<span class="nt">-N</span> DOCKER
<span class="nt">-N</span> DOCKER-ISOLATION-STAGE-1
<span class="nt">-N</span> DOCKER-ISOLATION-STAGE-2
<span class="nt">-N</span> DOCKER-USER
<span class="nt">-A</span> FORWARD <span class="nt">-j</span> DOCKER-USER
<span class="nt">-A</span> FORWARD <span class="nt">-j</span> DOCKER-ISOLATION-STAGE-1
<span class="nt">-A</span> FORWARD <span class="nt">-o</span> docker0 <span class="nt">-m</span> conntrack <span class="nt">--ctstate</span> RELATED,ESTABLISHED <span class="nt">-j</span> ACCEPT
<span class="nt">-A</span> FORWARD <span class="nt">-o</span> docker0 <span class="nt">-j</span> DOCKER
<span class="nt">-A</span> FORWARD <span class="nt">-i</span> docker0 <span class="o">!</span> <span class="nt">-o</span> docker0 <span class="nt">-j</span> ACCEPT
<span class="nt">-A</span> FORWARD <span class="nt">-i</span> docker0 <span class="nt">-o</span> docker0 <span class="nt">-j</span> ACCEPT
<span class="nt">-A</span> DOCKER-ISOLATION-STAGE-1 <span class="nt">-i</span> docker0 <span class="o">!</span> <span class="nt">-o</span> docker0 <span class="nt">-j</span> DOCKER-ISOLATION-STAGE-2
<span class="nt">-A</span> DOCKER-ISOLATION-STAGE-1 <span class="nt">-j</span> RETURN
<span class="nt">-A</span> DOCKER-ISOLATION-STAGE-2 <span class="nt">-o</span> docker0 <span class="nt">-j</span> DROP
<span class="nt">-A</span> DOCKER-ISOLATION-STAGE-2 <span class="nt">-j</span> RETURN
<span class="nt">-A</span> DOCKER-USER <span class="nt">-j</span> RETURN

<span class="c"># nat POSTROUTING 에 172.17.0.0/16 에서 외부로 전달 시 매스커레이딩(SNAT) 정책이 추가됨</span>
iptables <span class="nt">-t</span> nat <span class="nt">-S</span>
<span class="nt">-P</span> PREROUTING ACCEPT
<span class="nt">-P</span> INPUT ACCEPT
<span class="nt">-P</span> OUTPUT ACCEPT
<span class="nt">-P</span> POSTROUTING ACCEPT
<span class="nt">-N</span> DOCKER
<span class="nt">-A</span> PREROUTING <span class="nt">-m</span> addrtype <span class="nt">--dst-type</span> LOCAL <span class="nt">-j</span> DOCKER
<span class="nt">-A</span> OUTPUT <span class="o">!</span> <span class="nt">-d</span> 127.0.0.0/8 <span class="nt">-m</span> addrtype <span class="nt">--dst-type</span> LOCAL <span class="nt">-j</span> DOCKER
<span class="nt">-A</span> POSTROUTING <span class="nt">-s</span> 172.17.0.0/16 <span class="o">!</span> <span class="nt">-o</span> docker0 <span class="nt">-j</span> MASQUERADE
<span class="nt">-A</span> DOCKER <span class="nt">-i</span> docker0 <span class="nt">-j</span> RETURN
</code></pre></div></div> <h2 id="2-컨테이너-실행-및-확인">#2 컨테이너 실행 및 확인</h2> <p>Ubuntu 호스트 VM 에서 동작하는 컨테이너의 네트워크 정보 샘플</p> <p><img src="/assets/img/post_img/kang-container-network.png" alt="[생활코딩 Docker 입문수업 - 5. 네트워크](https://www.youtube.com/watch?v=SJFO2w5Q2HI)" /></p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># nginx 이미지를 컨테이너 백그라운드로 실행</span>
<span class="c"># -d 는 Detached 모드로 컨테이너를 실행. 컨테이너를 백그라운드에서 동작하는 애플리케이션으로써 실행하도록 설정.</span>
<span class="c"># Detached 모드인 컨테이너는 반드시 컨테이너에서 프로그램이 실행돼야 하며 프로그램이 실행되지 않으면 컨테이너는 종료됩니다.</span>
<span class="nv">$ </span>docker run <span class="nt">-d</span> nginx
<span class="nv">$ </span>docker ps

<span class="c"># 실행중인 컨테이너의 ID만 확인</span>
<span class="nv">$ </span>docker ps <span class="nt">-q</span>

<span class="c"># 컨테이너 상세 정보 확인</span>
<span class="c"># docker inspect '&lt;NAME&gt; 혹은 &lt;ID&gt;'</span>
<span class="nv">$ </span>docker inspect <span class="k">$(</span>docker ps <span class="nt">-q</span><span class="k">)</span>

<span class="c"># 컨테이너(=Instance)의 IP 정보 확인(JSON) - 링크</span>
<span class="c"># docker inspect --format='' $INSTANCE_ID</span>
<span class="nv">$ </span>docker inspect <span class="nt">-f</span> <span class="s1">''</span> <span class="k">$(</span>docker ps <span class="nt">-q</span><span class="k">)</span>
<span class="nv">$ </span>ping 172.17.0.2

<span class="c"># 호스트 네트워크 인터페이스 정보 확인</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> a
<span class="nv">$ </span>brctl show

<span class="c"># curl 로 http 접속 테스트 - 링크 링크2</span>
<span class="nv">$ </span>curl <span class="sb">`</span>docker inspect <span class="nt">-f</span> <span class="s1">''</span> <span class="k">$(</span>docker ps <span class="nt">-q</span><span class="k">)</span><span class="sb">`</span> | <span class="nb">grep</span> <span class="nt">-o</span> <span class="s1">'&lt;title&gt;.*&lt;/title&gt;'</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> 172.17.0.2 | <span class="nb">grep</span> <span class="nt">-o</span> <span class="s1">'&lt;title&gt;.*&lt;/title&gt;'</span>

<span class="c"># 컨테이너의 log 확인</span>
<span class="nv">$ </span>docker logs <span class="nt">-f</span> <span class="k">$(</span>docker ps <span class="nt">-q</span><span class="k">)</span>

<span class="c"># 컨테이너에 명령 실행</span>
<span class="c"># nginx 컨테이너의 index.html 파일의 위치는 /usr/share/nginx/html/index.html 입니다</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="k">$(</span>docker ps <span class="nt">-q</span><span class="k">)</span> <span class="nb">ls</span> /usr/share/nginx/html
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="k">$(</span>docker ps <span class="nt">-q</span><span class="k">)</span> <span class="nb">cat</span> /usr/share/nginx/html/index.html

<span class="c"># 실행 및 종료된 컨테이너까지 전부삭제</span>
<span class="nv">$ </span>docker rm <span class="nt">-f</span> <span class="k">$(</span>docker ps <span class="nt">-a</span> <span class="nt">-q</span><span class="k">)</span>
</code></pre></div></div> <h3 id="ubuntu1604-이미지에-bash-쉘-실행">ubuntu:16.04 이미지에 bash 쉘 실행</h3> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 호스트 Ubuntu 버전 확인</span>
<span class="nv">$ </span>lsb_release <span class="nt">-a</span>
No LSB modules are available.
Distributor ID: Ubuntu
Description:    Ubuntu 20.04.3 LTS
Release:        20.04
Codename:       focal

<span class="c"># ubuntu 16.04 컨테이너 실행하면서 bash 쉘 실행 → 컨테이너 내부로 진입</span>
<span class="nv">$ </span>docker run <span class="nt">--rm</span> <span class="nt">-it</span> ubuntu:16.04 bash

<span class="nv">$ </span><span class="nb">cat</span> /etc/os-release
<span class="nv">NAME</span><span class="o">=</span><span class="s2">"Ubuntu"</span>
<span class="nv">VERSION</span><span class="o">=</span><span class="s2">"16.04.7 LTS (Xenial Xerus)"</span>
<span class="nv">ID</span><span class="o">=</span>ubuntu
<span class="nv">ID_LIKE</span><span class="o">=</span>debian
<span class="nv">PRETTY_NAME</span><span class="o">=</span><span class="s2">"Ubuntu 16.04.7 LTS"</span>
<span class="nv">VERSION_ID</span><span class="o">=</span><span class="s2">"16.04"</span>
<span class="nv">HOME_URL</span><span class="o">=</span><span class="s2">"http://www.ubuntu.com/"</span>
<span class="nv">SUPPORT_URL</span><span class="o">=</span><span class="s2">"http://help.ubuntu.com/"</span>
<span class="nv">BUG_REPORT_URL</span><span class="o">=</span><span class="s2">"http://bugs.launchpad.net/ubuntu/"</span>
<span class="nv">VERSION_CODENAME</span><span class="o">=</span>xenial
<span class="nv">UBUNTU_CODENAME</span><span class="o">=</span>xenial

<span class="nv">$ </span>ps <span class="nt">-ef</span>
UID          PID    PPID  C STIME TTY          TIME CMD
root           1       0  0 09:56 pts/0    00:00:00 bash
root          12       1  0 09:56 pts/0    00:00:00 ps <span class="nt">-ef</span>

<span class="nv">$ </span><span class="nb">exit</span>

<span class="c"># 컨테이너 상태 확인</span>
docker ps
</code></pre></div></div> <h3 id="host-리눅스-배포판과-다른-centos-이미지를-실행하며-bash-쉘-실행">Host 리눅스 배포판과 다른 centos 이미지를 실행하며 bash 쉘 실행!</h3> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker run --rm -it centos bash

$ cat /etc/redhat-release
CentOS Linux release 8.4.2105

$ exit
</code></pre></div></div> <h3 id="tip-도커-호스트의-리눅스-배포판과-컨테이너의-커널-버전이-달라도-컨테이너가-동작하는-이유는">TIP 도커 호스트의 ‘리눅스 배포판’과 컨테이너의 ‘커널 버전’이 달라도 컨테이너가 동작하는 이유는?</h3> <ul> <li><code class="highlighter-rouge">LBS(Linux Base Standart)</code>는 소스 코드를 컴파일한 시점에서 호환성 있는 머신 코드를 생성하도록 ISO 규격으로 표준화되어 있다.</li> <li>리눅스 ABI(Application Binary Interface)로 인해 리눅스 커널의 버전이 올라가도 유저 공간에서 동작하는 <code class="highlighter-rouge">바이너리(머신 코드) 레벨의 호환성</code>은 유지된다.</li> <li>참고 링크 <ul> <li><a href="https://ko.wikipedia.org/wiki/%EC%9D%91%EC%9A%A9_%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%A8_%EC%9D%B4%EC%A7%84_%EC%9D%B8%ED%84%B0%ED%8E%98%EC%9D%B4%EC%8A%A4">응용 프로그램 이진 인터페이스</a></li> <li><a href="https://en.wikipedia.org/wiki/Application_binary_interface">Application binary interface</a></li> <li><a href="https://ko.wikipedia.org/wiki/%EB%A6%AC%EB%88%85%EC%8A%A4_%EA%B8%B0%EB%B3%B8_%EA%B7%9C%EA%B2%A9">리눅스 기본 규격</a></li> </ul> </li> </ul> <p><img src="/assets/img/post_img/application-binary-interface.png" alt="" /></p> <p><img src="/assets/img/post_img/application-binary-interface-wiki.png" alt="" /></p> <p>스터디에서 토론한 내용을 추가 합니다.</p> <blockquote> <p>[<strong>홀스</strong>]님 : 컨테이너가 다른버전 다른 os가 동작하는게 지금까지 알아본 정보는 CPU이 기계어 명령어 셋인 ISA가 각각 아키텍쳐 마다 다르고, OS에는 이 ISA와 연동되는 ABI가 있는데 이 부분이 호환되는거라 가능한걸로 알고 있습니다. 이 ABI는 제조사에서 커널에 개발해서 넣는 경우가 많다고 하고요. 이 커널의 경우는 linux foudation에서만 개발하기에 대부분 리눅스는 호환되고요. 그리고 ABI가 레드햇이라던가에서 따로 개발해서 넣는 경우도 있습니다. 만약 라이브러리나 어플리케이션이 이러한 ABI를 사용하게 될 경우 버전에 따라 동작 안할 수도 있습니다.</p> </blockquote> <blockquote> <p>[가우]님 : linux syscall r3-&gt;r0 (calling convention, asm 호환) 호환 및 아키텍쳐가 동일하다면 라이브러리에서 호환성을 가져갈수 있을것 같네요. 음 그런데 호스트 커널 버전이 낮고 도커이미지 버전이 높으면 일부 동작안하는 기능이 있을 것도 같군요</p> </blockquote> <p>단, 호스트와 <code class="highlighter-rouge">CPU 아키텍처</code>가 다른 컨테이너 이미지는 동작 불가합니다.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Host가 AMD CPU 일때</span>
<span class="nv">$ </span><span class="nb">cat</span> /proc/cpuinfo
processor       : 0
vendor_id       : AuthenticAMD
cpu family      : 23
model           : 96
model name      : AMD Ryzen 5 4500U with Radeon Graphics
stepping        : 1
microcode       : 0xffffffff
cpu MHz         : 2370.554
cache size      : 512 KB
...

<span class="c"># riscv64로 CPU 아키텍처로 실행하려고 하면 아래와 같이 오류가 발생합니다.</span>
<span class="nv">$ </span>docker run <span class="nt">--rm</span> <span class="nt">-it</span> riscv64/ubuntu bash
Unable to find image <span class="s1">'riscv64/ubuntu:latest'</span> locally
latest: Pulling from riscv64/ubuntu
8c703baf60b6: Pull <span class="nb">complete
</span>Digest: sha256:bc700522fdbb6d8fa43a6800954e3f12c6990df7e344649c05eafac375aa4dcf
Status: Downloaded newer image <span class="k">for </span>riscv64/ubuntu:latest
WARNING: The requested image<span class="s1">'s platform (linux/riscv64) does not match the detected host platform (linux/amd64) and no specific platform was requested
standard_init_linux.go:228: exec user process caused: exec format error
</span></code></pre></div></div> <h2 id="3-컨테이너-격리에-대하여">#3 컨테이너 격리에 대하여</h2> <p>컨테이너의 시작은 1979년 <code class="highlighter-rouge">chroot</code>에서로 부터 시작했습니다.</p> <p><img src="/assets/img/post_img/container-history.png" alt="[https://netpple.github.io/docs/make-container-without-docker/container-internal-1](https://netpple.github.io/docs/make-container-without-docker/container-internal-1)" /></p> <blockquote> <p>리눅스의 파일 시스템은 <code class="highlighter-rouge">root(/)</code>로 부터 시작합니다. 따라서 특정 디렉토리를 <code class="highlighter-rouge">root(/)</code>로 지정할수 있으면 해당 경로에 프로세스를 가두는 점에서 착안되었습니다. FTP(원격 유저)를 특정 디렉토리 경로에 가두기 위한 용도로 사용됩니다.</p> </blockquote> <p><code class="highlighter-rouge">chroot</code>를 사용하기 위해서는 필요한 프로그램들을 하나하나 복사해서 새로운 <code class="highlighter-rouge">root(/)</code> 디렉토리 밑으로 넣어두어야 합니다.</p> <p><img src="/assets/img/post_img/chroot-files.png" alt="[https://netpple.github.io/docs/make-container-without-docker/container-internal-1](https://netpple.github.io/docs/make-container-without-docker/container-internal-1)" /></p> <p>이렇게 필요한 파일들을 미리 넣어두어서 만들어두는 것을 <code class="highlighter-rouge">이미지</code>라고 하며, 흔히 <code class="highlighter-rouge">도커 이미지</code>라고 합니다</p> <p>하지만 <code class="highlighter-rouge">chroot</code>는 큰 취약점이 있습니다. 바로 <code class="highlighter-rouge">탈옥</code>이 가능하다는 것입니다. 이외에도 호스트와 격리 문제, 호스트 리소스를 제한 없이 사용이 가능하고, root 권한 및 다양한 보안 문제를 가지고 있습니다.</p> <blockquote> <p><code class="highlighter-rouge">탈옥</code>은 <code class="highlighter-rouge">root(/)</code> 디렉토리를 벗어나는 행위를 이야기 합니다. 이를 해결한 방법이 <code class="highlighter-rouge">pivot_root</code>와 <code class="highlighter-rouge">Namespace</code> 입니다. 또한 리소스에 대한 제한을 위해서는 <code class="highlighter-rouge">Cgroup</code>을 사용합니다. 더욱 자세한 내용은 <a href="https://netpple.github.io/docs/make-container-without-docker/container-internal-1">도커 없이 컨테이너 만들기</a>를 참조해주세요. :)</p> </blockquote> <p><img src="/assets/img/post_img/namespaces.png" alt="[https://wizardzines.com/comics/namespaces](https://wizardzines.com/comics/namespaces)" /></p> <p><img src="/assets/img/post_img/cgroup.png" alt="[https://wizardzines.com/comics/cgroups](https://wizardzines.com/comics/cgroups)" /></p> <blockquote> <p><code class="highlighter-rouge">Docker</code>를 이용할 경우 위의 문제점을 해결한 독립된 리눅스 환경을 보장받는 프로세스가 생성됩니다. 단, Host 프로세스에서 컨테이너(프로세스)를 종료할 수 있습니다. VM 환경에서는 Host에서 프로세스에 접근이 기본적으로 어렵습니다.</p> </blockquote> <p>아래는 Host에서 컨테이너의 파일에 접근하고 삭제하는 실습입니다.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 터미널1 (Ubuntu 컨테이너)</span>
<span class="c">## Ubuntu 컨테이너 bash 접속 후 명령어 실행</span>
docker run <span class="nt">--rm</span> <span class="nt">-it</span> ubuntu bash
<span class="c">## echo $$ : 현재 bash 쉘의 프로세스 ID - 링크</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$$</span>
1

<span class="nv">$ </span>ps <span class="nt">-ef</span>
UID          PID    PPID  C STIME TTY          TIME CMD
root           1       0  0 14:03 pts/0    00:00:00 bash
root          11       1  0 14:03 pts/0    00:00:00 ps <span class="nt">-ef</span>

<span class="nv">$ </span>ps afxuwww
USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root           1  0.0  0.1   4108  3680 pts/0    Ss   14:03   0:00 bash
root          12  0.0  0.1   5896  2948 pts/0    R+   14:03   0:00 ps afxuwww

<span class="c">## 현재 프로세스의 네임스페이스 정보 : 호스트와 컨테이너의 Namespace 중 ipc, mnt, net, pid, uts 가 다르다</span>
<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> /proc/<span class="nv">$$</span>/ns
total 0
lrwxrwxrwx 1 root root 0 Jan 13 14:04 cgroup -&gt; <span class="s1">'cgroup:[4026531835]'</span>
lrwxrwxrwx 1 root root 0 Jan 13 14:04 ipc -&gt; <span class="s1">'ipc:[4026532258]'</span>
lrwxrwxrwx 1 root root 0 Jan 13 14:04 mnt -&gt; <span class="s1">'mnt:[4026532256]'</span>
lrwxrwxrwx 1 root root 0 Jan 13 14:04 net -&gt; <span class="s1">'net:[4026532261]'</span>
lrwxrwxrwx 1 root root 0 Jan 13 14:04 pid -&gt; <span class="s1">'pid:[4026532259]'</span>
lrwxrwxrwx 1 root root 0 Jan 13 14:04 pid_for_children -&gt; <span class="s1">'pid:[4026532259]'</span>
lrwxrwxrwx 1 root root 0 Jan 13 14:04 user -&gt; <span class="s1">'user:[4026531837]'</span>
lrwxrwxrwx 1 root root 0 Jan 13 14:04 uts -&gt; <span class="s1">'uts:[4026532257]'</span>

<span class="c"># 터미널2 (호스트 Shell)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$$</span>
1424

<span class="nv">$ </span>ps <span class="nt">-ef</span> | <span class="nb">grep </span>bash
vagrant     1412    1411  0 08:46 pts/0    00:00:00 <span class="nt">-bash</span>
root        1424    1423  0 08:46 pts/0    00:00:00 <span class="nt">-bash</span>
root       12330    1424  0 14:00 pts/0    00:00:00 <span class="nb">grep</span> <span class="nt">--color</span><span class="o">=</span>auto bash

<span class="c"># 모든 프로세스 확인</span>
<span class="nv">$ </span>ps afxuwww
<span class="c"># 전체 프로세스가 표출됨</span>

<span class="c"># 네임 스페이스 확인</span>
<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> /proc/<span class="nv">$$</span>/ns
total 0
lrwxrwxrwx 1 root root 0 Jan 13 14:01 cgroup -&gt; <span class="s1">'cgroup:[4026531835]'</span>
lrwxrwxrwx 1 root root 0 Jan 13 14:01 ipc -&gt; <span class="s1">'ipc:[4026531839]'</span>
lrwxrwxrwx 1 root root 0 Jan 13 14:01 mnt -&gt; <span class="s1">'mnt:[4026531840]'</span>
lrwxrwxrwx 1 root root 0 Jan 13 14:01 net -&gt; <span class="s1">'net:[4026531992]'</span>
lrwxrwxrwx 1 root root 0 Jan 13 14:01 pid -&gt; <span class="s1">'pid:[4026531836]'</span>
lrwxrwxrwx 1 root root 0 Jan 13 14:01 pid_for_children -&gt; <span class="s1">'pid:[4026531836]'</span>
lrwxrwxrwx 1 root root 0 Jan 13 14:01 user -&gt; <span class="s1">'user:[4026531837]'</span>
lrwxrwxrwx 1 root root 0 Jan 13 14:01 uts -&gt; <span class="s1">'uts:[4026531838]'</span>

<span class="c"># UTS(호스트네임, 도메인네임)이 다르다!</span>
<span class="c">## 터미널1 (Ubuntu 컨테이너)</span>
<span class="nv">$ </span>hostname
<span class="nv">$ </span><span class="nb">cat</span> /etc/hostname
a1c2d8316afb

<span class="c">## 터미널2 (호스트 Shell)</span>
<span class="nv">$ </span>hostname
<span class="nv">$ </span><span class="nb">cat</span> /etc/hostname
ubuntu-focal

<span class="c"># PID(프로세스ID)가 다르다!</span>
<span class="c">## 터미널1 (Ubuntu 컨테이너)</span>
<span class="nv">$ </span>ps <span class="nt">-eaf</span>
UID          PID    PPID  C STIME TTY          TIME CMD
root           1       0  0 14:03 pts/0    00:00:00 bash
root          16       1  0 14:05 pts/0    00:00:00 ps <span class="nt">-eaf</span>

<span class="nv">$ </span>ps afxuwww
USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root           1  0.0  0.1   4108  3680 pts/0    Ss   14:03   0:00 bash
root          17  0.0  0.1   5896  3128 pts/0    R+   14:05   0:00 ps afxuwww


<span class="c">## 터미널2 (호스트 Shell)</span>
<span class="nv">$ </span>ps <span class="nt">-eaf</span>
<span class="nv">$ </span>ps afxuwww
<span class="c"># 모든 프로세스 표출</span>

<span class="c"># NET(네트워크 환경)이 다르다!</span>
<span class="c">## 터미널1 (Ubuntu 컨테이너)</span>
<span class="nv">$ </span>sed <span class="nt">-i</span> <span class="s1">'s/archive.ubuntu.com/ftp.daum.net/g'</span> /etc/apt/sources.list
<span class="nv">$ </span>apt update <span class="o">&amp;&amp;</span> apt <span class="nt">-y</span> install net-tools
<span class="c"># 설치 됨</span>

<span class="nv">$ </span>ifconfig
eth0: <span class="nv">flags</span><span class="o">=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
        inet 172.17.0.3  netmask 255.255.0.0  broadcast 172.17.255.255
        ether 02:42:ac:11:00:03  txqueuelen 0  <span class="o">(</span>Ethernet<span class="o">)</span>
        RX packets 7736  bytes 21137301 <span class="o">(</span>21.1 MB<span class="o">)</span>
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 3899  bytes 215690 <span class="o">(</span>215.6 KB<span class="o">)</span>
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

lo: <span class="nv">flags</span><span class="o">=</span>73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536
        inet 127.0.0.1  netmask 255.0.0.0
        loop  txqueuelen 1000  <span class="o">(</span>Local Loopback<span class="o">)</span>
        RX packets 0  bytes 0 <span class="o">(</span>0.0 B<span class="o">)</span>
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 0  bytes 0 <span class="o">(</span>0.0 B<span class="o">)</span>
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

<span class="nv">$ </span>route <span class="nt">-n</span>
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         172.17.0.1      0.0.0.0         UG    0      0        0 eth0
172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 eth0

<span class="c">## 터미널2 (호스트 Shell)</span>
<span class="nv">$ </span>ifconfig
docker0: <span class="nv">flags</span><span class="o">=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
        inet 172.17.0.1  netmask 255.255.0.0  broadcast 172.17.255.255
        inet6 fe80::42:9ff:fe51:ba05  prefixlen 64  scopeid 0x20&lt;link&gt;
        ether 02:42:09:51:ba:05  txqueuelen 0  <span class="o">(</span>Ethernet<span class="o">)</span>
        RX packets 3913  bytes 163570 <span class="o">(</span>163.5 KB<span class="o">)</span>
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 7747  bytes 21138259 <span class="o">(</span>21.1 MB<span class="o">)</span>
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

enp0s3: <span class="nv">flags</span><span class="o">=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
        inet 10.0.2.15  netmask 255.255.255.0  broadcast 10.0.2.255
        inet6 fe80::31:14ff:fe45:3203  prefixlen 64  scopeid 0x20&lt;link&gt;
        ether 02:31:14:45:32:03  txqueuelen 1000  <span class="o">(</span>Ethernet<span class="o">)</span>
        RX packets 251806  bytes 373931304 <span class="o">(</span>373.9 MB<span class="o">)</span>
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 52954  bytes 3428495 <span class="o">(</span>3.4 MB<span class="o">)</span>
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

enp0s8: <span class="nv">flags</span><span class="o">=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
        inet 192.168.50.10  netmask 255.255.255.0  broadcast 192.168.50.255
        inet6 fe80::a00:27ff:fe41:3ff2  prefixlen 64  scopeid 0x20&lt;link&gt;
        ether 08:00:27:41:3f:f2  txqueuelen 1000  <span class="o">(</span>Ethernet<span class="o">)</span>
        RX packets 0  bytes 0 <span class="o">(</span>0.0 B<span class="o">)</span>
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 33  bytes 2486 <span class="o">(</span>2.4 KB<span class="o">)</span>
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

lo: <span class="nv">flags</span><span class="o">=</span>73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536
        inet 127.0.0.1  netmask 255.0.0.0
        inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;
        loop  txqueuelen 1000  <span class="o">(</span>Local Loopback<span class="o">)</span>
        RX packets 2  bytes 124 <span class="o">(</span>124.0 B<span class="o">)</span>
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 2  bytes 124 <span class="o">(</span>124.0 B<span class="o">)</span>
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

veth2e41a0a: <span class="nv">flags</span><span class="o">=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
        inet6 fe80::2811:75ff:feb8:4ab  prefixlen 64  scopeid 0x20&lt;link&gt;
        ether 2a:11:75:b8:04:ab  txqueuelen 0  <span class="o">(</span>Ethernet<span class="o">)</span>
        RX packets 14  bytes 2662 <span class="o">(</span>2.6 KB<span class="o">)</span>
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 40  bytes 3152 <span class="o">(</span>3.1 KB<span class="o">)</span>
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

<span class="nv">$ </span>route <span class="nt">-n</span>
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         10.0.2.2        0.0.0.0         UG    100    0        0 enp0s3
10.0.2.0        0.0.0.0         255.255.255.0   U     0      0        0 enp0s3
10.0.2.2        0.0.0.0         255.255.255.255 UH    100    0        0 enp0s3
172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 docker0
192.168.50.0    0.0.0.0         255.255.255.0   U     0      0        0 enp0s8

<span class="c"># MNT(마운트 파일시스템 구조)가 다르다!</span>
<span class="c">## 터미널1 (Ubuntu 컨테이너) 파일 생성</span>
<span class="nv">$ </span><span class="nb">ls</span> /
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span> <span class="k">do </span>touch /deleteme.<span class="nv">$i</span><span class="p">;</span> <span class="k">done</span><span class="p">;</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'1q2w3e'</span> <span class="o">&gt;</span> /secret.txt
<span class="nv">$ </span><span class="nb">ls</span> /

<span class="c">## 터미널2 (호스트 Shell)</span>
<span class="nv">$ </span>tree <span class="nt">-L</span> 1 /
/
├── bin -&gt; usr/bin
├── boot
├── dev
├── etc
├── home
├── lib -&gt; usr/lib
├── lib32 -&gt; usr/lib32
├── lib64 -&gt; usr/lib64
├── libx32 -&gt; usr/libx32
├── lost+found
├── media
├── mnt
├── opt
├── proc
├── root
├── run
├── sbin -&gt; usr/sbin
├── snap
├── srv
├── sys
├── tmp
├── usr
└── var

<span class="nv">$ </span>findmnt <span class="nt">-t</span> overlay
TARGET                                                                                           SOURCE  FSTYPE OPTIONS
/var/lib/docker/overlay2/05bb70b4b6bb1c325a01ce9d9bf4c11053b2c73e136556717b1a65caa113d688/merged overlay overla rw,relat

<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-a</span> <span class="k">$(</span>findmnt <span class="nt">-t</span> overlay | <span class="nb">grep</span> <span class="nt">-v</span> TARGET | awk <span class="s1">'{print $1}'</span><span class="k">)</span>
/var/lib/docker/overlay2/05bb70b4b6bb1c325a01ce9d9bf4c11053b2c73e136556717b1a65caa113d688/merged:
<span class="nb">.</span>             deleteme.17  deleteme.3   deleteme.42  deleteme.55  deleteme.68  deleteme.80  deleteme.93  media
..            deleteme.18  deleteme.30  deleteme.43  deleteme.56  deleteme.69  deleteme.81  deleteme.94  mnt
.dockerenv    deleteme.19  deleteme.31  deleteme.44  deleteme.57  deleteme.7   deleteme.82  deleteme.95  opt
bin           deleteme.2   deleteme.32  deleteme.45  deleteme.58  deleteme.70  deleteme.83  deleteme.96  proc
boot          deleteme.20  deleteme.33  deleteme.46  deleteme.59  deleteme.71  deleteme.84  deleteme.97  root
deleteme.1    deleteme.21  deleteme.34  deleteme.47  deleteme.6   deleteme.72  deleteme.85  deleteme.98  run
deleteme.10   deleteme.22  deleteme.35  deleteme.48  deleteme.60  deleteme.73  deleteme.86  deleteme.99  sbin
deleteme.100  deleteme.23  deleteme.36  deleteme.49  deleteme.61  deleteme.74  deleteme.87  dev          secret.txt
deleteme.11   deleteme.24  deleteme.37  deleteme.5   deleteme.62  deleteme.75  deleteme.88  etc          srv
deleteme.12   deleteme.25  deleteme.38  deleteme.50  deleteme.63  deleteme.76  deleteme.89  home         sys
deleteme.13   deleteme.26  deleteme.39  deleteme.51  deleteme.64  deleteme.77  deleteme.9   lib          tmp
deleteme.14   deleteme.27  deleteme.4   deleteme.52  deleteme.65  deleteme.78  deleteme.90  lib32        usr
deleteme.15   deleteme.28  deleteme.40  deleteme.53  deleteme.66  deleteme.79  deleteme.91  lib64        var
deleteme.16   deleteme.29  deleteme.41  deleteme.54  deleteme.67  deleteme.8   deleteme.92  libx32

<span class="nv">$ </span><span class="nb">echo</span> <span class="k">$(</span>findmnt <span class="nt">-t</span> overlay | <span class="nb">grep</span> <span class="nt">-v</span> TARGET | awk <span class="s1">'{print $1}'</span><span class="k">)</span>
/var/lib/docker/overlay2/05bb70b4b6bb1c325a01ce9d9bf4c11053b2c73e136556717b1a65caa113d688/merged

<span class="nv">$ </span><span class="nb">cat</span> <span class="k">$(</span>findmnt <span class="nt">-t</span> overlay | <span class="nb">grep</span> <span class="nt">-v</span> TARGET | awk <span class="s1">'{print $1}'</span><span class="k">)</span>/secret.txt
1q2w3e

<span class="nv">$ </span>rm <span class="nt">-rf</span> <span class="k">$(</span>findmnt <span class="nt">-t</span> overlay | <span class="nb">grep</span> <span class="nt">-v</span> TARGET | awk <span class="s1">'{print $1}'</span><span class="k">)</span>/deleteme.<span class="k">*</span>
<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-a</span> <span class="k">$(</span>findmnt <span class="nt">-t</span> overlay | <span class="nb">grep</span> <span class="nt">-v</span> TARGET | awk <span class="s1">'{print $1}'</span><span class="k">)</span>
<span class="nb">.</span>   .dockerenv  boot  etc   lib    lib64   media  opt   root  sbin        srv  tmp  var
..  bin         dev   home  lib32  libx32  mnt    proc  run   secret.txt  sys  usr
</code></pre></div></div> <h2 id="참고-자료">참고 자료</h2> <ul> <li><a href="https://kubernetes.io/docs/concepts/overview/what-is-kubernetes/">https://kubernetes.io/docs/concepts/overview/what-is-kubernetes/</a></li> <li><a href="https://www.redhat.com/ko/topics/virtualization/what-is-a-hypervisor#%EA%B0%9C%EC%9A%94">하이퍼바이저란?</a></li> <li><a href="https://docs.docker.com/get-started/overview/#docker-architecture">docker-architecture</a></li> <li><a href="https://ko.wikipedia.org/wiki/%ED%94%84%EB%A1%9C%EB%B9%84%EC%A0%80%EB%8B%9D">프로비저닝</a></li> <li><a href="https://ko.wikipedia.org/wiki/%EC%9D%91%EC%9A%A9_%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%A8_%EC%9D%B4%EC%A7%84_%EC%9D%B8%ED%84%B0%ED%8E%98%EC%9D%B4%EC%8A%A4">응용 프로그램 이진 인터페이스</a></li> <li><a href="https://en.wikipedia.org/wiki/Application_binary_interface">Application binary interface</a></li> <li><a href="https://ko.wikipedia.org/wiki/%EB%A6%AC%EB%88%85%EC%8A%A4_%EA%B8%B0%EB%B3%B8_%EA%B7%9C%EA%B2%A9">리눅스 기본 규격</a></li> <li><a href="https://netpple.github.io/docs/make-container-without-docker/container-internal-1">1편.컨테이너 인터널(1)</a></li> <li><a href="https://netpple.github.io/docs/make-container-without-docker/container-internal-1">https://netpple.github.io/docs/make-container-without-docker/container-internal-1</a></li> <li><a href="https://wizardzines.com/comics/cgroups">https://wizardzines.com/comics/cgroups</a></li> </ul> <div class="entry-meta"> <br> <hr> <span class="entry-tags"><a href="https://lahuman.github.io/tags/#kang" title="Pages tagged kang" class="tag"><span class="term">kang</span></a><a href="https://lahuman.github.io/tags/#vagrant" title="Pages tagged vagrant" class="tag"><span class="term">vagrant</span></a><a href="https://lahuman.github.io/tags/#docker" title="Pages tagged docker" class="tag"><span class="term">docker</span></a></span> <span class="social-share"> <a href="https://www.facebook.com/sharer/sharer.php?u=https://lahuman.github.io/kang_1week_1/" title="Share on Facebook" class="tag"> <span class="term"><i class="fa fa-facebook-square"></i> Share</span> </a> <a href="https://twitter.com/intent/tweet?text=https://lahuman.github.io/kang_1week_1/" title="Share on Twitter" class="tag"> <span class="term"><i class="fa fa-twitter-square"></i> Tweet</span> </a> <a href="https://plus.google.com/share?url=https://lahuman.github.io/kang_1week_1/" title="Share on Google+" class="tag"> <span class="term"><i class="fa fa-google-plus-square"></i> +1</span> </a> </span> <div style="clear:both"></div> </div> <ins class="kakao_ad_area" style="display:none;" data-ad-unit = "DAN-ubp67fs9s850" data-ad-width = "320" data-ad-height = "100"></ins> <script type="text/javascript" src="//t1.daumcdn.net/kas/static/ba.min.js" async></script> </div> </div> <section id="disqus_thread" class="animated fadeInUp"></section><!-- /#disqus_thread --> </header> <!-- JS --> <script src="https://lahuman.github.io/assets/js/jquery-1.12.0.min.js"></script> <script src="https://lahuman.github.io/assets/js/jquery.dlmenu.min.js"></script> <script src="https://lahuman.github.io/assets/js/jquery.goup.min.js"></script> <script src="https://lahuman.github.io/assets/js/jquery.magnific-popup.min.js"></script> <script src="https://lahuman.github.io/assets/js/jquery.fitvid.min.js"></script> <script src="https://lahuman.github.io/assets/js/scripts.js"></script> <!-- Global site tag (gtag.js) - Google Analytics --> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-74095083-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-74095083-1'); </script> <script type="text/javascript"> var disqus_shortname = 'daniels-blog'; (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); (function () { var s = document.createElement('script'); s.async = true; s.type = 'text/javascript'; s.src = '//' + disqus_shortname + '.disqus.com/count.js'; (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s); }()); </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> <!-- MathJax --> <script async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> </body> </html>
