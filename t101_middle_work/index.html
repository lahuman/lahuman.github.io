<!DOCTYPE html> <!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--> <!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8"><![endif]--> <!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9"><![endif]--> <!--[if gt IE 8]><!--> <html class="no-js"><!--<![endif]--> <head> <meta charset="UTF-8"> <meta content="text/html; charset=UTF-8" http-equiv="Content-Type"> <meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"> <title>중간과제] Codepipeline with Terraform &#8211; lahuman</title> <meta name="description" content="열심히 사는 아저씨"> <meta name="keywords" content="terraform, study"> <!-- Twitter Cards --> <meta name="twitter:card" content="summary"> <meta name="twitter:image" content="https://lahuman.github.io/assets/img/logo.png"> <meta name="twitter:title" content="중간과제] Codepipeline with Terraform"> <meta name="twitter:description" content="Terraform 101 Study"> <!-- Open Graph --> <meta property="og:locale" content="ko_KR"> <meta property="og:type" content="article"> <meta property="og:title" content="중간과제] Codepipeline with Terraform"> <meta property="og:description" content="Terraform 101 Study"> <meta property="og:url" content="https://lahuman.github.io/t101_middle_work/"> <meta property="og:site_name" content="lahuman"> <meta property="og:image" content="https://lahuman.github.io/assets/img/logo.png"> <link rel="canonical" href="https://lahuman.github.io/t101_middle_work/"> <link href="https://lahuman.github.io/feed.xml" type="application/atom+xml" rel="alternate" title="lahuman Feed"> <!-- Handheld --> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- CSS --> <link rel="stylesheet" href="https://lahuman.github.io/assets/css/main.css"> <!-- JS --> <script src="https://lahuman.github.io/assets/js/modernizr-3.3.1.custom.min.js"></script> <!-- Favicons --> <link rel="apple-touch-icon" href="https://lahuman.github.io/assets/img/favicons/apple-icon-precomposed.png"> <link rel="apple-touch-icon" sizes="72x72" href="https://lahuman.github.io/assets/img/favicons/apple-icon-72x72.png"> <link rel="apple-touch-icon" sizes="114x114" href="https://lahuman.github.io/assets/img/favicons/apple-icon-114x114.png"> <link rel="apple-touch-icon" sizes="144x144" href="https://lahuman.github.io/assets/img/favicons/apple-icon-144x144.png"> <link rel="shortcut icon" type="image/png" href="https://lahuman.github.io/favicon.png" /> <link rel="shortcut icon" href="https://lahuman.github.io/favicon.ico" /> <!-- mermaid --> <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script> <script>mermaid.initialize({startOnLoad:true});</script> <!-- Background Image --> <style type="text/css">body {background-image:url(https://lahuman.github.io/assets/img/placeholder-big.jpg); background-repeat: no-repeat; background-size: cover; }</style> <!-- Post Feature Image --> </head> <body> <nav id="dl-menu" class="dl-menuwrapper" role="navigation"> <button class="dl-trigger">Open Menu</button> <ul class="dl-menu"> <li><a href="https://lahuman.github.io/">Home</a></li> <li> <a href="#">About</a> <ul class="dl-submenu"> <li> <img src="https://lahuman.github.io/assets/img/logo.png" alt="lahuman photo" class="author-photo"> <h4>lahuman</h4> <p>열심히 사는 아저씨</p> </li> <li><a href="https://lahuman.github.io/about/"><span class="btn btn-inverse">Learn More</span></a></li> <li> <a href="http://facebook.com/lahuman" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-facebook-square"></i> Facebook</a> </li> <li> <a href="http://linkedin.com/in/lahuman" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-linkedin-square"></i> LinkedIn</a> </li> <li> <a href="http://github.com/lahuman" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-github"></i> Github</a> </li> </ul>
<!-- /.dl-submenu --> </li> <li> <a href="#">Posts</a> <ul class="dl-submenu"> <li><a href="https://lahuman.github.io/posts/">All Posts</a></li> <li><a href="https://lahuman.github.io/tags/">All Tags</a></li> </ul> </li> <li><a href="https://lahuman.github.io/projects/">Projects</a></li> </ul>
<!-- /.dl-menu --> </nav><!-- /.dl-menuwrapper --> <!-- Header --> <header class="header" role="banner"> <div class="wrapper animated fadeIn"> <div class="content"> <div class="post-title "> <h1>중간과제] Codepipeline with Terraform</h1> <h4>07 Nov 2022</h4> <p class="reading-time"> <i class="fa fa-clock-o"></i> Reading time ~3 minutes </p>
<!-- /.entry-reading-time --> <a class="btn zoombtn" href="https://lahuman.github.io/projects/"> <i class="fa fa-chevron-left"></i> </a> </div> <h1 id="codepipeline-with-terraform">Codepipeline with Terraform</h1> <blockquote> <p>현재 저희 팀에서는 <a href="https://aws.amazon.com/ko/codepipeline/">Codepipeline</a>을 <a href="https://aws.amazon.com/ko/ecr/">ECR</a>에 이미지를 적재하고, <a href="https://aws.amazon.com/ko/ecs/">ECS</a>로 서비스를 운영하고 있습니다.</p> </blockquote> <p>신규 작업으로 <a href="https://docs.aws.amazon.com/ko_kr/lambda/latest/dg/welcome.html">Lambda</a>를 사용하는데, <a href="https://aws.amazon.com/ko/codepipeline/">Codepipeline</a>과 <a href="https://www.terraform.io/">Terraform</a>을 이용하는 방법을 정리 합니다.</p> <h1 id="aws-lambda-cicd">AWS Lambda CI/CD</h1> <h2 id="using-terraform-and-codepipeline"><em>using Terraform and CodePipeline</em></h2> <p>이 예제는 CodePipeline 및 Terraform을 사용한 지속적인 통합 및 배포를 통해 완벽하게 작동하는 AWS Lambda 샘플 서비스를 설정하는 데 도움이 됩니다.</p> <h3 id="전체-구성도">전체 구성도</h3> <p><img src="https://github.com/lahuman/aws-lambda-cicd-terraform/blob/main/assets/process_flow.png" alt=""></p> <h2 id="prerequiste">Prerequiste</h2> <ul> <li><a href="https://aws.amazon.com/cli/">AWS Cli</a></li> <li><a href="https://developer.hashicorp.com/terraform/tutorials/aws-get-started/install-cli">Terraform Cli</a></li> <li><a href="https://docs.docker.com/engine/install/">docker</a></li> </ul> <h2 id="features">Features</h2> <ul> <li>AWS Lambda Function - <a href="https://pypi.org/project/beautifulsoup4/">bs4</a>를 활용해서 https://lahuman.github.io 의 title 을 출력</li> <li>CI/CD - Complete CodePipeline: <a href="https://aws.amazon.com/codecommit/">CodeCommit</a>, Source, Build, Deploy</li> <li>Private <a href="https://aws.amazon.com/ecr/">Elastic Container Registry</a> for your AWS Lambda Code</li> </ul> <h2 id="instruction">Instruction</h2> <p>프로젝트 Clone 처리</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/lahuman/aws-lambda-cicd-terraform.git
<span class="nb">cd </span>aws-lambda-cicd-terraform/terraform
</code></pre></div></div> <p><code class="highlighter-rouge">terraform.tfvars</code> 파일에서 주요 내용 수정</p> <ul> <li>org_name = “ORG_NAME”</li> <li>team_name = “TEAM_NAME”</li> <li>project_id = “PROJECT_ID”</li> <li>region = “REGION”</li> </ul> <p><code class="highlighter-rouge">providers.tf</code> 에서도 region을 <code class="highlighter-rouge">terraform.tfvars</code>과 동일하게 변경 처리</p> <ul> <li>region = “REGION”</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>terraform init
terraform apply

<span class="c"># 성공 메시지</span>
....
Apply <span class="nb">complete</span><span class="o">!</span> Resources: 15 added, 0 changed, 0 destroyed.
....
</code></pre></div></div> <h3 id="초기-이미지-push-후-ecr">초기 이미지 push 후 ECR</h3> <p><img src="https://github.com/lahuman/aws-lambda-cicd-terraform/blob/main/assets/ecr_repository.png" alt=""></p> <p>성공시 아래와 같은 리소스들이 생성됩니다.</p> <ul> <li>iam, role, policy, CodeCommit, Lambda function, CodePipeline, Etc</li> </ul> <h2 id="아직-끝나지-않았습니다">아직 끝나지 않았습니다.</h2> <p>codeCommit에 코드를 추가해야 합니다.</p> <h3 id="비어있는-repository">비어있는 repository</h3> <p><img src="https://github.com/lahuman/aws-lambda-cicd-terraform/blob/main/assets/codecommit-repo.png" alt=""></p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># move to the directory you want to make lambda code project director</span>
git clone https://git-codecommit.<span class="k">${</span><span class="nv">REGION</span><span class="k">}</span>.amazonaws.com/v1/repos/<span class="k">${</span><span class="nv">ORG_NAME</span><span class="k">}</span>-<span class="k">${</span><span class="nv">TEAM_NAME</span><span class="k">}</span>-<span class="k">${</span><span class="nv">PROJECT_ID</span><span class="k">}</span>_test_code_repo
<span class="c"># copy sample code to repo directory</span>
cp ./aws-lambda-cicd-terraform/lambdacode/<span class="k">*</span> ./<span class="k">${</span><span class="nv">ORG_NAME</span><span class="k">}</span>-<span class="k">${</span><span class="nv">TEAM_NAME</span><span class="k">}</span>-<span class="k">${</span><span class="nv">PROJECT_ID</span><span class="k">}</span>_test_code_repo/
<span class="c"># move to cloned repo directory</span>
<span class="nb">cd</span> <span class="k">${</span><span class="nv">ORG_NAME</span><span class="k">}</span>-<span class="k">${</span><span class="nv">TEAM_NAME</span><span class="k">}</span>-<span class="k">${</span><span class="nv">PROJECT_ID</span><span class="k">}</span>_test_code_repo
<span class="c"># push sample code to repo</span>
git add <span class="nb">.</span>
git commit <span class="nt">-m</span> <span class="s2">"Initial commit"</span>
git push
</code></pre></div></div> <h2 id="cicd--빌드-및-배포-준비가-다-되었습니다">CICD -빌드 및 배포 준비가 다 되었습니다.</h2> <ul> <li>AWS 웹 콘솔에서 <code class="highlighter-rouge">CodeCommit</code>으로 이동하세요.</li> <li> <p><code class="highlighter-rouge">CodePipeline</code> 메뉴를 클릭하세요.</p> </li> <li>
<code class="highlighter-rouge">Release</code> 버튼을 클릭하세요</li> </ul> <p><img src="https://github.com/lahuman/aws-lambda-cicd-terraform/blob/main/assets/codepipeline-detail.png" width="600"></p> <h2 id="checkout-updated-lambda">Checkout updated Lambda</h2> <ul> <li>CodeDeploy는 CodeBuild 단계에서 빌드된 Docker 이미지와 함께 AWS Cli를 사용하여 CodeCommit에 푸시된 소스 코드로 대체합니다.</li> </ul> <p><img src="https://github.com/lahuman/aws-lambda-cicd-terraform/blob/main/assets/lambda.png" width="300"></p> <ul> <li>
<code class="highlighter-rouge">Lambda</code> 테스트</li> </ul> <p><img src="https://github.com/lahuman/aws-lambda-cicd-terraform/blob/main/assets/lambda-detail.png" width="650"></p> <p><img src="https://github.com/lahuman/aws-lambda-cicd-terraform/blob/main/assets/lambda-test.png" width="650"></p> <h1 id="lambda-코드-배포-방법에-대해-고려해야-할-사항">Lambda 코드 배포 방법에 대해 고려해야 할 사항</h1> <ul> <li>이미지와 함께 람다를 배포하는 경우 AWS 웹 콘솔에서 직접 코드를 볼 수 없습니다.</li> <li>AWS에 람다 코드를 배포하는 다른 방법이 있습니다. 소스 코드를 압축하고 이를 교체하여 람다 코드를 업데이트할 수 있습니다.</li> </ul> <h2 id="reference">Reference</h2> <ul> <li>https://github.com/aws-samples/codepipeline-for-lambda-using-terraform</li> <li>https://www.maxivanov.io/deploy-aws-lambda-to-vpc-with-terraform/</li> </ul> <h2 id="20221112-변경-내역">2022.11.12 변경 내역</h2> <ul> <li>module 간 의존성 추가 처리</li> </ul> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>module "ecr" {
  source            = "./modules/ecr"
  general_namespace = local.general_namespace
  env_namespace     = local.env_namespace
  default_region    = var.region
  account_id        = data.aws_caller_identity.current.account_id
}

module "lambda" {
  # 이부분을 추가 
  depends_on = [module.ecr] # After completion of module.ecr
  source = "./modules/lambda"
  env_namespace = local.env_namespace
  ecr_repo_arn = module.ecr.ecr_configs.ecr_repo_arn
  ecr_repo_url = module.ecr.ecr_configs.ecr_repo_url
}

# ./module/lambda/main.tf 에 sleep 기존 부분 삭제 처리
# ecr을 생성하고 docker image를 업로드 하는데 약 30초의 시간이 걸립니다. 이를 기다리게 하기 위해서 time_sleep를 사용하였습니다
# 더 좋은 방법이 있을꺼 같은데 찾아봐야겠습니다.
resource "null_resource" "previous" {}
# sleep 40 seconds
resource "time_sleep" "wait_40_seconds" {
  depends_on = [null_resource.previous]
  create_duration = "40s"
}

resource "aws_lambda_function" "this" {
    depends_on = [time_sleep.wait_40_seconds]
    .....
}
</code></pre></div></div> <h2 id="20221111-변경-내역">2022.11.11 변경 내역</h2> <ul> <li>local-exec로 초기 이미지 push 처리 ``` <h1 id="moduleecrmaintf-에서">./module/ecr/main.tf 에서</h1> <h1 id="local-exec-의-의미가-현재-terraform-을-실행하는-머신에서-실행한다는-의미-입니다">local-exec 의 의미가 현재 terraform 을 실행하는 머신에서 실행한다는 의미 입니다.</h1> </li> </ul> <p>resource “null_resource” “docker_build” { # on Terraform Running Machine provisioner “local-exec” { interpreter = [“bash”, “-c”] command = «-EOT aws ecr get-login-password –region ${var.default_region} | docker login –username AWS –password-stdin ${var.account_id}.dkr.ecr.${var.default_region}.amazonaws.com docker pull public.ecr.aws/lambda/python:3.8 docker tag public.ecr.aws/lambda/python:3.8 ${var.account_id}.dkr.ecr.${var.default_region}.amazonaws.com/${var.general_namespace}_test_docker_repo:latest docker push ${var.account_id}.dkr.ecr.${var.default_region}.amazonaws.com/${var.general_namespace}_test_docker_repo:latest EOT } }</p> <h1 id="modulelambdamaintf">./module/lambda/main.tf</h1> <h1 id="ecr을-생성하고-docker-image를-업로드-하는데-약-30초의-시간이-걸립니다-이를-기다리게-하기-위해서-time_sleep를-사용하였습니다">ecr을 생성하고 docker image를 업로드 하는데 약 30초의 시간이 걸립니다. 이를 기다리게 하기 위해서 time_sleep를 사용하였습니다</h1> <h1 id="더-좋은-방법이-있을꺼-같은데-찾아봐야겠습니다">더 좋은 방법이 있을꺼 같은데 찾아봐야겠습니다.</h1> <p>resource “null_resource” “previous” {}</p> <h1 id="sleep-40-seconds">sleep 40 seconds</h1> <p>resource “time_sleep” “wait_40_seconds” { depends_on = [null_resource.previous] create_duration = “40s” }</p> <p>resource “aws_lambda_function” “this” { depends_on = [time_sleep.wait_40_seconds] ….. } ```</p> <h2 id="작업에--도움-주신분">작업에 도움 주신분</h2> <ul> <li><a href="https://www.shinphil.com/kr">신필용</a></li> <li>
<a href="http://t101.cloudneta.net">t101 스터디 멤버</a> <ul> <li>@지닉-진익현</li> <li>
<a href="https://github.com/ddiiwoong" class="user-mention">@ddiiwoong</a> - 김진웅</li> </ul> </li> </ul> <div class="entry-meta"> <br> <hr> <span class="entry-tags"><a href="https://lahuman.github.io/tags/#terraform" title="Pages tagged terraform" class="tag"><span class="term">terraform</span></a><a href="https://lahuman.github.io/tags/#study" title="Pages tagged study" class="tag"><span class="term">study</span></a></span> <span class="social-share"> <a href="https://www.facebook.com/sharer/sharer.php?u=https://lahuman.github.io/t101_middle_work/" title="Share on Facebook" class="tag"> <span class="term"><i class="fa fa-facebook-square"></i> Share</span> </a> <a href="https://twitter.com/intent/tweet?text=https://lahuman.github.io/t101_middle_work/" title="Share on Twitter" class="tag"> <span class="term"><i class="fa fa-twitter-square"></i> Tweet</span> </a> <a href="https://plus.google.com/share?url=https://lahuman.github.io/t101_middle_work/" title="Share on Google+" class="tag"> <span class="term"><i class="fa fa-google-plus-square"></i> +1</span> </a> </span> <div style="clear:both"></div> </div> <ins class="kakao_ad_area" style="display:none;" data-ad-unit="DAN-ubp67fs9s850" data-ad-width="320" data-ad-height="100"></ins> <script type="text/javascript" src="//t1.daumcdn.net/kas/static/ba.min.js" async></script> </div> </div> <section id="disqus_thread" class="animated fadeInUp"></section><!-- /#disqus_thread --> </header> <!-- JS --> <script src="https://lahuman.github.io/assets/js/jquery-1.12.0.min.js"></script> <script src="https://lahuman.github.io/assets/js/jquery.dlmenu.min.js"></script> <script src="https://lahuman.github.io/assets/js/jquery.goup.min.js"></script> <script src="https://lahuman.github.io/assets/js/jquery.magnific-popup.min.js"></script> <script src="https://lahuman.github.io/assets/js/jquery.fitvid.min.js"></script> <script src="https://lahuman.github.io/assets/js/scripts.js"></script> <!-- Global site tag (gtag.js) - Google Analytics --> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-74095083-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-74095083-1'); </script> <script type="text/javascript"> var disqus_shortname = 'daniels-blog'; (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); (function () { var s = document.createElement('script'); s.async = true; s.type = 'text/javascript'; s.src = '//' + disqus_shortname + '.disqus.com/count.js'; (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s); }()); </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript> <!-- MathJax --> <script async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> </body> </html>
